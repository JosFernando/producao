<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Gestão de Resíduos</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    

    <style>
        :root {
            --primary-color: rgb(5 150 105); /* Emerald-600 */
            --primary-hover: rgb(4 120 87); /* Emerald-700 */
            --background-color: #f8fafc; /* Slate-50 */
            --sidebar-bg: rgb(6 78 59); /* Emerald-900 */
            --sidebar-text: #d1fae5; /* Emerald-100 */
            --card-bg: #ffffff;
            --text-primary: #1f2937; /* Gray-800 */
            --text-secondary: #6b7280; /* Gray-500 */
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            font-weight: 400;
        }
        .sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-text); }
        .sidebar .logo { padding: 1rem; text-align: center; }
        .sidebar .logo img { max-width: 150px; }
        .nav-link {
            padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.75rem;
            border-radius: 0.375rem; transition: background-color 0.2s; font-weight: 400;
        }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-color); color: #fff; font-weight: 500; }
        .stat-card {
            background-color: var(--card-bg); border-radius: 0.75rem; padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            display: flex; align-items: center; gap: 1rem;
        }
        .stat-card .icon {
            font-size: 1.75rem;
            color: var(--primary-color);
            background-color: #d1fae5;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .metric-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .btn-primary { background-color: var(--primary-color); color: white; font-weight: 500; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-primary:disabled { background-color: rgb(5 150 105 / 0.5); cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; font-weight: 500; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888;
            border-radius: 0.5rem; width: 90%; max-width: 600px; animation: fadeIn 0.3s;
        }
        .modal-content-lg { max-width: 800px; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .page { display: none; }
        .page.active { display: block; }
        th { font-weight: 500; }

        /* Estilos para o Relatório */
        #pdf-content {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 10mm auto;
            border: 1px #D3D3D3 solid;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #pdf-footer {
            position: absolute;
            bottom: 10mm;
            left: 15mm;
            right: 15mm;
            text-align: center;
            font-size: 9pt;
            color: #888;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md">
            <!-- Login Form -->
            <div id="login-view">
                <form id="login-form" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                    <div class="mb-8 text-center">
                        <img src="./logo.png" alt="Logo Narisrec" class="mx-auto max-w-[150px]">
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">Bem-vindo de volta!</h2>
                        <p class="text-gray-500">Faça login para continuar</p>
                    </div>
                     <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email">Email</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-email" type="email" placeholder="Email" required>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <label class="block text-gray-700 text-sm font-bold" for="login-password">Password</label>
                            <a href="#" id="forgot-password-link" class="inline-block align-baseline font-bold text-sm text-emerald-600 hover:text-emerald-800">
                                Esqueci a senha
                            </a>
                        </div>
                        <div class="relative mt-2">
                             <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-password" type="password" placeholder="******************" required>
                             <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                 <i class="fas fa-eye text-gray-500 cursor-pointer" id="password-toggle"></i>
                             </span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button id="login-btn" class="btn-primary w-full font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2" type="submit">
                            Entrar
                        </button>
                    </div>
                    <p class="text-center text-gray-500 text-sm mt-6">
                        Não tem uma conta? <a href="#" id="show-register" class="font-bold text-emerald-600 hover:text-emerald-800">Crie uma aqui</a>.
                    </p>
                </form>
            </div>

            <!-- Register Form -->
            <div id="register-view" class="hidden">
                 <form id="register-form" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                    <div class="mb-8 text-center">
                         <img src="./logo.png" alt="Logo Narisrec" class="mx-auto max-w-[150px]">
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">Criar Conta</h2>
                        <p class="text-gray-500">Comece a gerir os seus resíduos hoje</p>
                    </div>
                     <div id="register-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="register-name">Nome</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="register-name" type="text" placeholder="Nome Completo" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="register-email">Email</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="register-email" type="email" placeholder="Email" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">Password</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="register-password" type="password" placeholder="******************" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <button class="btn-primary w-full font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                            Registar
                        </button>
                    </div>
                     <p class="text-center text-gray-500 text-sm mt-6">
                        Já tem uma conta? <a href="#" id="show-login-from-register" class="font-bold text-emerald-600 hover:text-emerald-800">Faça login</a>.
                    </p>
                </form>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgot-password-view" class="hidden">
                <form id="forgot-password-form" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                    <div class="mb-8 text-center">
                        <img src="./logo.png" alt="Logo Narisrec" class="mx-auto max-w-[150px]">
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">Recuperar Senha</h2>
                        <p class="text-gray-500">Insira o seu email para receber o link de recuperação</p>
                    </div>
                     <div id="forgot-password-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="forgot-password-email">Email</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="forgot-password-email" type="email" placeholder="Email" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button id="forgot-password-btn" class="btn-primary w-full font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2" type="submit">
                            Enviar Email de Recuperação
                        </button>
                    </div>
                    <p class="text-center text-gray-500 text-sm mt-6">
                        Lembrou-se da senha? <a href="#" id="show-login-from-forgot" class="font-bold text-emerald-600 hover:text-emerald-800">Voltar ao login</a>.
                    </p>
                </form>
            </div>

        </div>
    </div>
    
    <!-- App Container -->
    <div id="app-container" class="hidden h-screen w-full">
        <!-- Sidebar -->
        <aside class="sidebar w-64 min-h-screen p-4 flex flex-col">
            <div class="logo mb-8">
                <img src="./logo.png" alt="Logo Narisrec">
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="#" class="nav-link" data-page="ecoponto"><i class="fas fa-map-marker-alt"></i> Ecoponto</a>
                <a href="#" class="nav-link" data-page="ecoponto-form"><i class="fas fa-edit"></i> Formulário Ecoponto</a>
                <a href="#" class="nav-link" data-page="clientes"><i class="fas fa-users"></i> Clientes</a>
                <a href="#" class="nav-link" data-page="produtos"><i class="fas fa-box-open"></i> Produtos</a>
                <a href="#" class="nav-link" data-page="equipamentos"><i class="fas fa-clipboard-list"></i> Equipamentos</a>
                <a href="#" class="nav-link" data-page="materia-prima"><i class="fas fa-recycle"></i> Matéria-Prima</a>
                <a href="#" class="nav-link" data-page="relatorios"><i class="fas fa-file-alt"></i> Relatórios</a>
                <a href="#" class="nav-link" data-page="utilizadores"><i class="fas fa-user-cog"></i> Utilizadores</a>
            </nav>
            <div class="mt-auto p-4 text-center text-sm">
                <p>&copy; <span id="copyright-year"></span> Narisrec</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-10 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <h1 id="page-title" class="text-3xl font-bold text-gray-800">Dashboard</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <img src="https://placehold.co/40x40/059669/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full" id="user-avatar">
                        <div>
                            <p id="user-name" class="font-semibold">Utilizador</p>
                            <p id="user-email" class="text-sm text-gray-500">email@example.com</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-emerald-600" title="Terminar Sessão">
                        <i class="fas fa-sign-out-alt fa-lg"></i>
                    </button>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <!-- Filters -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <label for="cliente-filter" class="text-sm font-medium">Cliente:</label>
                        <select id="cliente-filter" class="border border-gray-300 rounded-md px-3 py-2 w-48">
                            <option value="todos">Todos os Clientes</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="data-inicio" class="text-sm font-medium">Data Início:</label>
                        <input type="date" id="data-inicio" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="data-fim" class="text-sm font-medium">Data Fim:</label>
                        <input type="date" id="data-fim" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="flex gap-2">
                        <button id="filter-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-filter"></i> Filtrar</button>
                        <button id="clear-filter-btn" class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-undo"></i> Limpar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                     <div class="stat-card">
                        <div class="icon"><i class="fas fa-truck"></i></div>
                        <div class="min-w-0">
                            <p class="text-gray-500 break-words">Nº de Recolhas</p>
                            <p id="stat-recolhas" class="text-2xl font-bold truncate">0</p>
                        </div>
                    </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-truck-loading"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Resíduos Recolhidos</p><p id="stat-residuos" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-boxes"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Equipamentos</p><p id="stat-equipamentos" class="text-2xl font-bold truncate">0</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-recycle"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Matéria-Prima Recuperada</p><p id="stat-materia-prima" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-leaf"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">CO₂e Evitado</p><p id="stat-co2" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm"> <h3 class="font-semibold mb-4">Recolhas nos Últimos Meses</h3> <canvas id="recolhasChart"></canvas> </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"> <h3 class="font-semibold mb-4">Top 5 Tipos de Equipamento</h3> <canvas id="topEquipamentosChart"></canvas> </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Secção de Equipamentos -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Equipamentos Mais Frequentes</h3>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2">Equipamento</th>
                                    <th class="p-2 text-right">Unidades</th>
                                </tr>
                            </thead>
                            <tbody id="top-equipamentos-body">
                               <!-- Dados dinâmicos -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Secção de Matéria-Prima -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top Matérias-Primas Recuperadas</h3>
                         <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2">Matéria-Prima</th>
                                    <th class="p-2 text-right">Peso Total</th>
                                </tr>
                            </thead>
                            <tbody id="top-materia-prima-body">
                               <!-- Dados dinâmicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Ecoponto Page -->
            <div id="ecoponto-page" class="page">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Ecoponto</h2>
                </div>
                 <!-- Filters -->
                 <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <label for="ecoponto-cliente-filter" class="text-sm font-medium">Cliente:</label>
                        <select id="ecoponto-cliente-filter" class="border border-gray-300 rounded-md px-3 py-2 w-48">
                            <option value="todos">Todos os Clientes</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="ecoponto-data-inicio" class="text-sm font-medium">Data Início:</label>
                        <input type="date" id="ecoponto-data-inicio" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="ecoponto-data-fim" class="text-sm font-medium">Data Fim:</label>
                        <input type="date" id="ecoponto-data-fim" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="ecoponto-filter-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-filter"></i> Filtrar</button>
                        <button id="ecoponto-clear-filter-btn" class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-undo"></i> Limpar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-truck"></i></div>
                        <div class="min-w-0">
                            <p class="text-gray-500 break-words">Nº de Entradas</p>
                            <p id="stat-recolhas-ecoponto" class="text-2xl font-bold truncate">0</p>
                        </div>
                    </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-truck-loading"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Resíduos (Ecoponto)</p><p id="stat-residuos-ecoponto" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-boxes"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Equipamentos (Ecoponto)</p><p id="stat-equipamentos-ecoponto" class="text-2xl font-bold truncate">0</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-recycle"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">Matéria-Prima (Ecoponto)</p><p id="stat-materia-prima-ecoponto" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-leaf"></i></div> <div class="min-w-0"><p class="text-gray-500 break-words">CO₂e Evitado (Ecoponto)</p><p id="stat-co2-ecoponto" class="text-2xl font-bold truncate">0 kg</p></div> </div>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Secção de Equipamentos (Ecoponto) -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Equipamentos Mais Frequentes (Ecoponto)</h3>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2">Equipamento</th>
                                    <th class="p-2 text-right">Unidades</th>
                                </tr>
                            </thead>
                            <tbody id="ecoponto-top-equipamentos-body">
                               <!-- Dados dinâmicos -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Secção de Matéria-Prima (Ecoponto) -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Top Matérias-Primas (Ecoponto)</h3>
                         <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2">Matéria-Prima</th>
                                    <th class="p-2 text-right">Peso Total</th>
                                </tr>
                            </thead>
                            <tbody id="ecoponto-top-materia-prima-body">
                               <!-- Dados dinâmicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Tabela de Registos Ecoponto -->
                <div class="bg-white p-6 rounded-lg shadow-sm mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Todos os Registos do Ecoponto</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Data</th>
                                    <th class="p-3">Cliente</th>
                                    <th class="p-3">Responsável</th>
                                    <th class="p-3">Total Matéria-Prima (kg)</th>
                                    <th class="p-3">Total Equipamentos (unid.)</th>
                                    <th class="p-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ecoponto-registos-list">
                                <!-- Dados dinâmicos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ecoponto Form Page -->
            <div id="ecoponto-form-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="ecoponto-form-title" class="text-2xl font-bold text-gray-800 mb-6">Novo Registo de Ecoponto</h2>
                    <form id="ecoponto-registo-form">
                        <input type="hidden" id="ecoponto-form-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <div>
                                <label for="ecoponto-form-cliente-select" class="block text-sm font-medium text-gray-700">Cliente</label>
                                <select id="ecoponto-form-cliente-select" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></select>
                            </div>
                            <div>
                                <label for="ecoponto-form-data" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="ecoponto-form-data" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">Matéria-Prima</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Metal -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <label class="flex items-center gap-3 text-lg font-medium text-gray-700 mb-2">
                                    <i class="fas fa-cogs text-gray-500"></i> Metal
                                </label>
                                <input type="number" step="0.01" id="ecoponto-form-metal" placeholder="Peso (kg)" class="w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <!-- Plásticos -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <label class="flex items-center gap-3 text-lg font-medium text-gray-700 mb-2">
                                    <i class="fas fa-bottle-water text-gray-500"></i> Plásticos
                                </label>
                                <input type="number" step="0.01" id="ecoponto-form-plasticos" placeholder="Peso (kg)" class="w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                             <!-- Vidro -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <label class="flex items-center gap-3 text-lg font-medium text-gray-700 mb-2">
                                    <i class="fas fa-wine-bottle text-gray-500"></i> Vidro
                                </label>
                                <input type="number" step="0.01" id="ecoponto-form-vidro" placeholder="Peso (kg)" class="w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                             <!-- Papel -->
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <label class="flex items-center gap-3 text-lg font-medium text-gray-700 mb-2">
                                    <i class="fas fa-newspaper text-gray-500"></i> Papel
                                </label>
                                <input type="number" step="0.01" id="ecoponto-form-papel" placeholder="Peso (kg)" class="w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">Equipamentos</h3>
                        <div id="ecoponto-form-equipamentos-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Equipamentos dinâmicos aqui -->
                        </div>

                        <div class="flex justify-end mt-8">
                            <button type="submit" class="btn-primary px-6 py-2 rounded-lg flex items-center justify-center gap-2 w-36 h-10">
                                Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Clientes Page -->
            <div id="clientes-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Lista de Clientes</h2>
                        <button id="add-cliente-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Novo Cliente</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"> <tr> <th class="p-3">Nome</th> <th class="p-3">NIF</th> <th class="p-3">Tipo</th> <th class="p-3">Contacto</th> <th class="p-3">Email</th> <th class="p-3">Ações</th> </tr> </thead>
                        <tbody id="clientes-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- Produtos Page -->
            <div id="produtos-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Lista de Produtos</h2>
                        <button id="add-produto-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Novo Produto</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"> <tr> <th class="p-3">ID</th> <th class="p-3">Nome do Produto</th> <th class="p-3">Categoria</th> <th class="p-3">Origem</th> <th class="p-3">Ações</th> </tr> </thead>
                        <tbody id="produtos-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- Equipamentos Page (antigo Inventário) -->
            <div id="equipamentos-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Registos de Equipamentos</h2>
                        <button id="add-equipamento-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Novo Registo</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"> <tr> <th class="p-3">Ref. Recolha</th> <th class="p-3">Cliente</th> <th class="p-3">Data Início</th> <th class="p-3">Origem</th> <th class="p-3">Responsável</th> <th class="p-3">Ações</th> </tr> </thead>
                        <tbody id="equipamentos-list"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Matéria-Prima Page -->
            <div id="materia-prima-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Registos de Matéria-Prima</h2>
                        <button id="add-materia-prima-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Novo Registo</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"> <tr> <th class="p-3">Ref. Recolha</th> <th class="p-3">Cliente</th> <th class="p-3">Data</th><th class="p-3">Origem</th> <th class="p-3">Responsável</th> <th class="p-3">Ações</th> </tr> </thead>
                        <tbody id="materia-prima-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- Relatórios Page -->
            <div id="relatorios-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Gerar Relatórios</h2>
                    <div class="bg-gray-50 p-4 rounded-md border flex flex-wrap items-center gap-4">
                        <div>
                            <label for="report-cliente-filter" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <select id="report-cliente-filter" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                <option value="todos">Todos os Clientes</option>
                            </select>
                        </div>
                        <div>
                            <label for="report-data-inicio" class="block text-sm font-medium text-gray-700">Data Início</label>
                            <input type="date" id="report-data-inicio" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="report-type" class="block text-sm font-medium text-gray-700">Tipo de Relatório</label>
                            <select id="report-type" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                <option value="geral">Geral</option>
                                <option value="producao">Produção</option>
                                <option value="ecoponto">Ecoponto</option>
                            </select>
                        </div>
                        <div>
                            <label for="report-data-fim" class="block text-sm font-medium text-gray-700">Data Fim</label>
                            <input type="date" id="report-data-fim" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div class="self-end">
                            <button id="generate-report-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center justify-center gap-2 w-48 h-10">
                                Gerar PDF
                            </button>
                        </div>
                    </div>
                    <!-- Report Preview Area -->
                    <div id="report-preview-container" class="mt-8"></div>
                </div>
            </div>

            <!-- Utilizadores Page -->
            <div id="utilizadores-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Gestão de Utilizadores</h2>
                        <button id="add-user-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Novo Utilizador</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"> <tr> <th class="p-3">Nome</th> <th class="p-3">Email</th> <th class="p-3">Função</th> <th class="p-3">Estado</th> <th class="p-3">Ações</th> </tr> </thead>
                        <tbody id="users-list"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="confirm-modal-body" class="mb-6">Tem a certeza que quer apagar este registo? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end gap-4">
                <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded">Apagar</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 id="info-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="info-modal-body" class="mb-6"></p>
            <div class="flex justify-end gap-4">
                <button type="button" class="close-modal btn-primary px-4 py-2 rounded">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="cliente-modal" class="modal"> <div class="modal-content"> <h3 class="text-2xl font-bold mb-4" id="cliente-modal-title"></h3> <form id="cliente-form"> <input type="hidden" id="cliente-id"> <div class="mb-4"> <label for="cliente-nome" class="block">Nome</label> <input type="text" id="cliente-nome" class="w-full border p-2 rounded" required> </div> <div class="mb-4"> <label for="cliente-nif" class="block">NIF</label> <input type="text" id="cliente-nif" class="w-full border p-2 rounded" required> </div> <div class="mb-4"> <label for="cliente-tipo" class="block">Tipo</label> <select id="cliente-tipo" class="w-full border p-2 rounded"><option value="Produção">Produção</option><option value="Ecoponto">Ecoponto</option></select> </div> <div class="mb-4"> <label for="cliente-contacto" class="block">Contacto</label> <input type="text" id="cliente-contacto" class="w-full border p-2 rounded"> </div> <div class="mb-4"> <label for="cliente-email" class="block">Email</label> <input type="email" id="cliente-email" class="w-full border p-2 rounded"> </div> <div class="flex justify-end gap-4"> <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button> <button type="submit" class="btn-primary px-4 py-2 rounded w-28 h-10 flex items-center justify-center">Salvar</button> </div> </form> </div> </div>
    <div id="produto-modal" class="modal"> <div class="modal-content"> <h3 class="text-2xl font-bold mb-4" id="produto-modal-title"></h3> <form id="produto-form"> <input type="hidden" id="produto-id"> <div class="mb-4"> <label for="produto-nome" class="block">Nome do Produto</label> <input type="text" id="produto-nome" class="w-full border p-2 rounded" required> </div> <div class="mb-4"> <label for="produto-categoria" class="block">Categoria</label> <select id="produto-categoria" class="w-full border p-2 rounded"> <option value="Equipamento">Equipamento</option> <option value="Matéria-prima">Matéria-prima</option> </select> </div> <div class="mb-4"> <label for="produto-origem" class="block">Origem</label> <select id="produto-origem" class="w-full border p-2 rounded"><option value="Produção">Produção</option><option value="Ecoponto">Ecoponto</option></select> </div> <div class="flex justify-end gap-4"> <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button> <button type="submit" class="btn-primary px-4 py-2 rounded w-28 h-10 flex items-center justify-center">Salvar</button> </div> </form> </div> </div>
    
    <div id="equipamento-modal" class="modal"> 
        <div class="modal-content modal-content-lg">
            <h3 id="equipamento-modal-title" class="text-2xl font-bold mb-4">Novo Registo de Equipamento</h3> 
            <form id="equipamento-form"> 
                <input type="hidden" id="equipamento-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"> 
                    <div><label for="ref-recolha-equipamento">Ref. Recolha:</label><input type="text" id="ref-recolha-equipamento" class="w-full border p-2 rounded mt-1"></div>
                    <div><label for="equipamento-lote">Lote:</label><input type="text" id="equipamento-lote" class="w-full border p-2 rounded mt-1"></div>
                    <div><label for="equipamento-cliente-select">Cliente:</label><select id="equipamento-cliente-select" class="w-full border p-2 rounded mt-1"></select></div> 
                    <div><label for="equipamento-data-inicio">Data Início:</label><input type="date" id="equipamento-data-inicio" class="w-full border p-2 rounded mt-1"></div> 
                    <div><label for="equipamento-data-fim">Data Fim:</label><input type="date" id="equipamento-data-fim" class="w-full border p-2 rounded mt-1"></div>
                    <div>
                        <label for="equipamento-origem">Origem:</label>
                        <select id="equipamento-origem" class="w-full border p-2 rounded mt-1">
                            <option value="Produção">Produção</option>
                            <option value="Ecoponto">Ecoponto</option>
                        </select>
                    </div>
                </div> 
                
                <h4 class="font-semibold mt-6 mb-2 border-t pt-4">Adicionar Equipamento</h4>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 items-end">
                    <div class="md:col-span-2">
                        <label for="equipamento-item-tipo" class="block text-sm font-medium">Tipo</label>
                        <div class="relative">
                            <input type="text" id="equipamento-item-tipo" class="w-full border p-2 rounded mt-1" autocomplete="off">
                            <div id="equipamento-tipo-results" class="absolute z-10 w-full bg-white border rounded mt-1 max-h-48 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <div>
                        <label for="equipamento-item-marca" class="block text-sm font-medium">Marca</label>
                        <input type="text" id="equipamento-item-marca" class="w-full border p-2 rounded mt-1">
                    </div>
                    <div>
                        <label for="equipamento-item-modelo" class="block text-sm font-medium">Modelo</label>
                        <input type="text" id="equipamento-item-modelo" class="w-full border p-2 rounded mt-1">
                    </div>
                    <div>
                        <label for="equipamento-item-nserie" class="block text-sm font-medium">Nº Serie</label>
                        <input type="text" id="equipamento-item-nserie" class="w-full border p-2 rounded mt-1">
                    </div>
                    <div>
                        <label for="equipamento-item-qty" class="block text-sm font-medium">Qtd.</label>
                        <input type="number" id="equipamento-item-qty" class="w-full border p-2 rounded mt-1" value="1" min="1">
                    </div>
                    <button type="button" id="add-equipamento-item-btn" class="btn-secondary px-4 py-2 rounded-lg h-10">Adicionar</button>
                </div>

                <h4 class="font-semibold mt-6 mb-2">Equipamentos Adicionados (<span id="equipamento-total-unidades">0</span>)</h4>
                <div class="max-h-60 overflow-y-auto border rounded-lg">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-2">Tipo</th>
                                <th class="p-2">Marca</th>
                                <th class="p-2">Modelo</th>
                                <th class="p-2">Qtd.</th>
                                <th class="p-2">Nº Serie</th>
                                <th class="p-2">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentos-adicionados-list">
                            <!-- Items will be added here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <label for="equipamento-peso-total" class="block text-sm font-medium text-gray-700">Peso Total (Kg):</label>
                    <input type="number" step="0.01" id="equipamento-peso-total" class="w-full border p-2 rounded mt-1" placeholder="Opcional">
                </div>
                <div class="mt-4">
                    <label for="equipamento-observacoes" class="block text-sm font-medium text-gray-700">Observações:</label>
                    <textarea id="equipamento-observacoes" rows="3" class="w-full border p-2 rounded mt-1"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-8"> 
                    <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button> 
                    <button type="submit" class="btn-primary px-4 py-2 rounded w-28 h-10 flex items-center justify-center">Salvar</button> 
                </div> 
            </form> 
        </div> 
    </div>

    <div id="materia-prima-modal" class="modal"> 
        <div class="modal-content modal-content-lg"> 
            <h3 id="materia-prima-modal-title" class="text-2xl font-bold mb-4">Novo Registo de Matéria-Prima</h3> 
            <form id="materia-prima-form"> 
                <input type="hidden" id="materia-prima-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"> 
                    <div><label for="ref-recolha-materia">Ref. Recolha:</label><input type="text" id="ref-recolha-materia" class="w-full border p-2 rounded mt-1"></div>
                    <div><label for="materia-prima-lote">Lote:</label><input type="text" id="materia-prima-lote" class="w-full border p-2 rounded mt-1"></div>
                    <div><label for="materia-prima-cliente-select">Cliente:</label><select id="materia-prima-cliente-select" class="w-full border p-2 rounded mt-1"></select></div> 
                    <div><label for="materia-prima-data-inicio">Data Início:</label><input type="date" id="materia-prima-data-inicio" class="w-full border p-2 rounded mt-1"></div> 
                    <div><label for="materia-prima-data-fim">Data Fim:</label><input type="date" id="materia-prima-data-fim" class="w-full border p-2 rounded mt-1"></div>
                    <div> <label for="materia-prima-origem">Origem:</label> <select id="materia-prima-origem" class="w-full border p-2 rounded mt-1"> <option value="Produção">Produção</option> <option value="Ecoponto">Ecoponto</option> </select> </div>
                </div> 
                <h4 class="font-semibold mt-6 mb-2">Matérias-Primas</h4>
                <div id="materia-prima-quantidades-container" class="max-h-72 overflow-y-auto p-1 grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Cards de Matéria-Prima serão injetados aqui -->
                </div>
                <div class="mt-4 font-bold text-right"> Peso Total (Kg): <span id="materia-prima-peso-total">0.00</span> </div> 
                <div class="flex justify-end gap-4 mt-6"> 
                    <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button> 
                    <button type="submit" class="btn-primary px-4 py-2 rounded w-28 h-10 flex items-center justify-center">Salvar</button> 
                </div> 
            </form> 
        </div> 
    </div>
    <div id="user-modal" class="modal"> <div class="modal-content"> <h3 class="text-2xl font-bold mb-4" id="user-modal-title"></h3> <form id="user-form"> <input type="hidden" id="user-id"> <div class="mb-4"> <label for="user-nome" class="block">Nome</label> <input type="text" id="user-nome" class="w-full border p-2 rounded" required> </div> <div class="mb-4"> <label for="user-email" class="block">Email</label> <input type="email" id="user-email" class="w-full border p-2 rounded" readonly> </div> <div class="mb-4"> <label for="user-funcao" class="block">Função</label> <select id="user-funcao" class="w-full border p-2 rounded"> <option value="Admin">Admin</option> <option value="Utilizador">Utilizador</option> </select> </div> <div class="flex justify-end gap-4"> <button type="button" class="close-modal btn-secondary px-4 py-2 rounded">Cancelar</button> <button type="submit" class="btn-primary px-4 py-2 rounded w-28 h-10 flex items-center justify-center">Salvar</button> </div> </form> </div> </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function() {
            
            let db, auth, userId, appId;
            let clientesUnsubscribe, produtosUnsubscribe, equipamentosUnsubscribe, materiaPrimaUnsubscribe, utilizadoresUnsubscribe, ecopontoRegistosUnsubscribe;
            
            // --- ESTADO DA APLICAÇÃO ---
            let onConfirmCallback = null; // For confirmation modal
            let liveClientes = [];
            let liveProdutos = [];
            let liveEquipamentos = [];
            let liveMateriaPrima = [];
            let liveUtilizadores = [];
            let liveEcopontoRegistos = [];
            let currentUserNome = '';
            let currentUserRole = 'Utilizador';
            let addedEquipments = []; // Array para gerir equipamentos adicionados no modal

            // --- ELEMENTOS DO DOM ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const forgotPasswordView = document.getElementById('forgot-password-view');
            
            // Logótipo em Base64 para o PDF
            const logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAABDCAMAAAC1QzLAAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJAUExURQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQAAAAEBAQC8byKyAAAAd3RSTlMAAQIDBAUGBwgJCgsMDQ4PEBESExQVFhcYGRobHB0eHyAhIiMkJSYnKCkqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4DPz9/v8/UOuRgAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAs/SURBVHhe7Vz5U1tnFf4p5wQCA0JgEAQhCAgRBVWLaq1WW6t1tba39gUv+AW9d71rrW31tVdt7V27613r9+23hBwSEpIQMh83k8l83/O9J2dm5sycMzP3Nn5YWFhYWFiU/k+k009IJKVKS0uTlZX1r9sZFRX1m1f5fL6SkpKqqqoS+LDR0dH/Xk1NTUlNTf1/s0+k8R8sLCwsLMoF+0Aag2lpaf/x7+zstMfjEYlE/J2enva8vLz+/v5er9f7+/u9vb2pqamurq62tvaampr+/v5SqfR/KRaLvb29TU1NtbW1Xq/X6/X6/f2dnZ1Op1MaGhrKysr+5v/j4+ODg4O+vr6GhgbgLS0t+sX45OQkMDCwb2V+Vlb21+/t7c3Nza2treXk5FRXVzc3N7e2tvLz83t6esrlci6Xi6VScXFxNTU1aWlpvV7v6uoanp6empqa3Nzcir44OjrKzc2NiYnxD9/5+/sPGM0/LpVKdXd3KxaL0Wi0Wq0SiTQ1NaWmpqqrq+vq6trb24eHh5eWliYnJ0tKSgYHB4eHh52dnQMDA3t6enp6errdbs/Ozqenpy0tLTk5ORUVFWVlZXV1dXR0tLS09OjoqKur6+zsTCQSKpXK4+Pj8vLyo6OjnZ2ddXV1TU1Nf39/g8Hwer29vb1paWlKpTIyMjI8PDwxMTE4ODgkJCQkJCQkJGRoaGhpaWlubq6vrx8dHQ0ICJiRkfEH/PbtW61WW1paGh4ejkQiR0ZGEhIShoaG0tLSwsLCJiYmDg4O7u7uSktLCwsLX19fsVi8s7PTarWmpqb+8/T8/HxfX19TU1Nzc3Nra2tra2tdXd3c3Nze3t7e3t7e3t7e3t7b29vS0lJXV9fe3j48PLyoqGhkZGR2djYjIyMuLu7c3NzMzMyEhAQ/P7+JiYmurq5qtVqtVqfT6Xa7/f7+/v7+UqlUKpWmpqbCwsKcnJzIyMjfv38/Nzdvbm7es2cPEokYGRkZGhrazs6uqampqa7u7u5uampKSkrKysry8/Pz8vKqqqrq6uqqqqra2toaGhpWVVVRUNBIJBIPDw8NDS2srKyvrKwUCsVisfj5+TU1tSUkJDx69Ojg4KCtrW1oaMhkMsPDwyMjI+Pj4xMTEwsLC/f39y8uLs7Pz4+MjIyOjoaGhubm5tbW1lZWVpaWlnJycnJycjIzMy0tLV1dXQkJCWVlZQkJCUNDQ4PB0NfXx2AwoaGhXV1dbW1tf39/c3NzfX19bW1tbW1tc3NzZWVldHT09PS0Wq0SiSQqKgoNDQ0ODg4JCQkJCUlPT3/8+HHGGBMTExMTE3FxcYGBgX5+fqenp5GRkd3d3XV1dV1dXV1dXU1NTUlJSVJSUkVFRVVVVXV1dUNDg1KpdLvdLpdrMBhoNBqNRrVarVartVotEonExMQkJCTIyspGRkaam5sbGhpqa2tTU1PBYDAWi2Vra2tpabm7u3d0dEydOnW8ePF6vV5PT4/+/v7a2pqWllZzc7Narebm5lZWVqampvb29ra2ttbWVmpqKj8/v7m5+ciRI5GRkT4+PnZ2diEhISEhISUlJWVlZQkJiZubm5aWlpaWlpeXl5SUVF5eXl5e3tPTM3369Nzc3G+++WZiYuI/jP/8+kUZ/sLCwsLBY4B/4Rzq9qKiovb3d5XLt7OzUarVKpSIQCAQCwWg0+v3+3NzchIQER0dHQ0NDaWlpeXl5Xl5efn5+RkaGWq1uampqa2tra2sbGhpw1dTUVFtbW1ZWlpOTk5OTk5eXV1ZWVlRUxMfHi4iIiIuL++LFCzqd7vHxkUgkKpXKycnJzc3NycnJycnJycnJycmpqKiYmJj8/PyamprS0tKioqLCwsKcnJxcXV3R0dEFBQXBwcH37t0TERGxWCwiIiJOTk5gYGChoaGJiYm5ublLS0v9/Pz8/Pze3t6enp7VavX7/ZGRkbGxsamrq0dERLz//vvi4uKbm5u1tbWNjY0NDQ0NDQ2tra3Nzc0MDAwiIiJiYmLCw8PT0tJycnJLS0tTU1N9fX1TU9P+/v7+/v7GxkY/Pz8rK+vhw4fR0dECgeDs7Iyfn//w4cPMzMzMzMyam5uzs7M+Pj6HDx+Ojo6ur68rKytzcnKGhoaSkhI+Pj6dnZ3W1tYhISGJiYnd3Nzu7m5nZ6fZbDabzc7Ozu7u7ubm5vb29tbW1vb29paWloaGhsbGxoaGhgYGBvr7+9va2jo6OlZWVs7OzjU1NcPDwxMTEy0tLcPDw7Ozsz4+PuXl5Xl5ebm5uUVFRS4uLuHh4cLCwoqKioGBgcrKytzc3OTkZGBg4OLiYmBgYGJiYmdn5+rq6ubmZn19/dra2tLS0v7+/uLiYlxcXGxsLDs7u6SkpLa29qVLl9zc3IaGhu7u7qampjY2Nra2tpqamqamppaWFhcXFxaLxWKxWKxWq9VqjY2Nzc3N7e3tDQ0NFRUVZWVlKSkpNTU1c3Pz0tLS4ODggICApaWlrq6u5eXlhQsXZmZm5uXl/euvvw4ePJiQkJCampqUlFRcXFxSUhIZGRkZGVlYWBgeHh4aGkpHx+LiYhQKNTIyKigoWLt2rdVqpaenFxkZ2dzcnJ2dvbq6mpqa+v3+wcHBwsLCyMjIyMhIMpms1mptbe3bt29LS0tTU1NXV1d3d3dXV9fc3NzU1NTY2NjY2NiampqYmBgymczKyoqPj3/w4EFMTAz8S0pKWltbu7m5NTU1ra2tubm5zc3NnZ2d8fHxAQEBzc3NBQUF+fn5OTk5LS0tdXV1LS0tCQkJXV1dBQUFiYmKSkpKcnJysrKyoqKi6uro6OjqioqKbm5vNzc0ZGRkZGRkZGRnZ2dm5uLienp4WFhba2tqamprKysqamprg4OCsrKyWlhZTU1N2dnZTU9O1a9dSUlKurKyOjo6Wlpaqqqra2trg4ODa2trGxkZXV1dTU5OZmZmRkZGZmZnY2NjCwsL8/Pzs7OyoqKisrKySkhIaGpq6ujo+Pj53d3c7OzuTk5MLCwtLSkppaWhISEuLi4vDwsLDw8MLCwsbGxsLC4urq6sDAgPj4+Ly8vMrKym5ubiMjI9va2lpbW8vLy4uLi/v6+jY0NPz9/XNzc4PBkJCQMDIy+vr6JiYmjo6OFRUVc3PzpqYmIiIiDQ0NbW3trq6usrKygoKCtra2d+/e/ejRo9OnT8vIyNjY2NTW1hYUFJiamtra2tra2lpaWjIyMlJSUtbW1rq6utbW1ubm5vb29tLS0q6uLvA+Pj4ODw9nZmaCg4Nzc3OHhoaWlhZiYmKCg4Orqqry8vLCw8Pr6up6enqWlpbQ0FAzM7Ozs7Orq6tTU1NTU1N3d3dPT09LS0tNTU1aWhocHBwWFubp6ZmZmfniiy+cnJzw8PB+fn4DAwMLCwu7urrq6uoSiUQikWhtbd25c2dLS8uZM2eGhobOnTt3dnbm5eUlJSUdHR3Ly8uLioqenp4ODw8bGRkFBQVRUVH9/f1tbe3t7e1VVVWlpaX5+fl+fn43N3d7e3tzc3Nzc3N7e7uysrKurm5ubu7v7xcKhbm5uZGRkZubW2ho6Llz51paWiwtLf39/S0tLSkpKUlJSVFREfTKyko/Pz8/P7+JiYmurq4ymUyv15uampqampqbm2tra2trapqaGmxoaGhoqKurm5KSioyMHB4ezsrKqqio6OzsLCoqysrKGhsbS0pKGhkZWVpampKSKikp0dXVNTQ0NDY2NjU1NTY2Njc3Nzc3N7u7u+fn52dnZ6enp4ODgzIyMsPDw+Pj42Pj4yMjIwsLC4ODg4uLi7u7u7e3t7e3t7+/v7e39+nTp9ra2rKyMjw8PDw8PDw8vKSkZE5OTl5eXk5OTllZWVRUVHl5eUtLy8DAwPz8/MzMzPz8/MzMzIqKioCAgKmpqbi4uMzMzOjo6MHBwYCAwMTERGVl5ZkzZ8bGxkZERKSlpS0sLOzu7r6+vjc3N9bWVmNj48zMjI6ObmhomJqampqa2tvb29raxsbGoqKirq6ura2tpaWltra2tra2tra2trW1tba21tLSkpqaWlpaGh4eHh4eXllZWVZWlp6eXlhYWFlZWVZWVlRUFBAQMDY2ZmRkNDAwMDExMTU1NTU11dXV1dXV1dXV1dXV1dTU1NfX19bW1tbW1tY2NjcPDw8/Pz9/f38bGRkxMzPLy8szMjLy8vJycnJwcDAwMDLg8fHxSUlJISEhDQ0NfX19/f39/f19f38/NDTU19fH4eFBQUFBRUWFSCRCQ0MLCwtbW1tzcnL29vbx8fEikYhEIsVikUgkEomJRDw9PRUUFBQXF3t7ey9fvrx27dqpU6e2trba2tq2trbW1ta2tjYHBweDg4Otra3+/v4uLi4uLi4uLi5gZ2dnZ2dnZ2cHBwfb2tq6urqWlhYYGJiamrq6upqZmZmanl5bW1tXV1dXV1dXV1dbW9u///3vvr6+vr6+fn5+kZGRkZGRaWlpISEhjY2NR44cycvL29jYGBgYeHl5FRYWjoyMrKys+Pj4JCQkKSkpenp64eHhnZ2dnZ2d7e3tFRUVJyenm5ubnZ1dTU3N7Ozs6+vL4XAYDIbD4XA4HAaDwWCdTqfRaPQGAwEMsVhssVgsFApFItFqtVqtVqfT6XQ6nU6n0+l0Op1OJ4lEIpFIxGIxCoWq1SoAhULBYrFYLBaLxWKx2Gw2g8EAAABqtVqtVqfT6XQ6nU6n0+l0Op2dnZ2dne3t7Q0NDQ0NDY2NjXV1dS0sLBwcHExMTDQ0NPT09GxsbGxsbBwcHExMTBwcHBQUFFy4cCHs6dOnHjx4EBgYGBkZWVlZ+cc//mFubu4ff/yRl5d3cHC4uroaGBjY2NiYmJiYmJi4urpSUlLCwsLa2trS0lJXV9fc3NzQ0JCTk7OwsLCwsLAwMDIyMjIyMrKwsJiYmKurq6SkZEJCQlpampWVlZubm5aWlra2toaGhgICAhoaGm5ubsLCwsLCwsLCQlxcnJqa2tfXt7S0jIyMzMzMjI2Nubi4nJ2d/f39jIyMTE1NbW1tfX19DQ0N/f39cXFx3d3d3d3dbW1tDQ0N7e3tDQ0NraysrKysrKyMjIywsDCd4eXk5OTnJycmlpaWlpSVYWVlZWFlZWZmZmZmZubm5ubm5gZ2dnb29vbW1tbm5+fbt20OHDj179iw+Pj4rKysoKChgYGDg4ODx8fHh4eGJiYmJiYnh4eHh4eHi4uLh4eHs7GxgYGBiYmJoaGhqampqampqampqbm5ubm7u7++fn58fHR19fHx8fHx8fHxKSkoSiSQxMVFcXKytrc3KyoqIiJiYmLCwsLCwsFgsFgsrKyvBYBgKhcVisVgsFovBYDAYDAYDAYPDw8Pb2tqamprCwsLS0lJXV1dTUxMLC4uRkZGLi8vc3NyUlJSsrKympiZfX18PD4+7u7urq6vR0dH+/n5xcfFf6vQPKysr/wV2e5/I5L+wsLDwWqCPdPpFRUVaWlpSUlJ+fn5lZWVqampCQkJ8fHx0dHRISEhERET/c79Y/E+P/v+wsLCwsLDw6j7/ATK7E2gL/QdBAAAAAElFTSuQmCC";

            // --- FUNÇÕES DE HELPERS ---
            
            function setButtonLoadingState(button, isLoading, loadingText) {
                if (!button) return;
                const originalText = button.dataset.originalText || button.innerHTML;
                if (!button.dataset.originalText) {
                    button.dataset.originalText = originalText;
                }

                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
                } else {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            function handleNavClick(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                const pageId = e.currentTarget.dataset.page + '-page';
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                document.getElementById('page-title').textContent = e.currentTarget.textContent.trim();
                 if(pageId === 'dashboard-page' || pageId === 'ecoponto-page') {
                    applyFiltersAndRender();
                 }
                if (pageId === 'ecoponto-form-page') {
                    document.getElementById('ecoponto-registo-form').reset();
                    document.getElementById('ecoponto-form-id').value = '';
                    document.getElementById('ecoponto-form-title').textContent = 'Novo Registo de Ecoponto';
                    renderEcopontoFormEquipamentos();
                }
            }

             // --- LÓGICA DE AUTENTICAÇÃO ---
            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');
                const button = document.getElementById('login-btn');

                errorDiv.classList.add('hidden');
                setButtonLoadingState(button, true, "A entrar...");

                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        console.error('Erro de login:', error.message);
                        errorDiv.textContent = 'Email ou password inválidos ou conta pendente.';
                        errorDiv.classList.remove('hidden');
                    })
                    .finally(() => {
                        setButtonLoadingState(button, false, 'Entrar');
                    });
            }

            async function handleRegister(e) {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('register-error');
                const button = e.currentTarget.querySelector('button[type="submit"]');
                
                errorDiv.classList.add('hidden');
                setButtonLoadingState(button, true, "A registar...");

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    const userDocRef = doc(db, 'artifacts', appId, 'public/data/utilizadores', user.uid);
                    await setDoc(userDocRef, { 
                        nome: name, 
                        email: email, 
                        funcao: 'Utilizador',
                        status: 'pendente' 
                    });
                     await signOut(auth);

                    showInfoModal('Registo Concluído', 'A sua conta aguarda aprovação de um administrador.');
                    registerView.classList.add('hidden');
                    loginView.classList.remove('hidden');
                    document.getElementById('register-form').reset();


                } catch (error) {
                    console.error('Erro de registo:', error.message);
                    if (error.code === 'auth/email-already-in-use') {
                         errorDiv.innerHTML = 'Este email já está a ser utilizado. <a href="#" id="switch-to-login-from-register" class="font-bold underline">Tente fazer login.</a>';
                         document.getElementById('switch-to-login-from-register').addEventListener('click', (e) => {
                            e.preventDefault();
                            registerView.classList.add('hidden');
                            loginView.classList.remove('hidden');
                         });
                    } else {
                        errorDiv.textContent = 'Não foi possível criar a conta. Tente novamente.';
                    }
                     errorDiv.classList.remove('hidden');
                } finally {
                    setButtonLoadingState(button, false, 'Registar');
                }
            }


            function handleLogout() {
                signOut(auth).catch(error => console.error('Erro ao terminar sessão:', error));
            }

            function handleForgotPassword(e) {
                e.preventDefault();
                const email = document.getElementById('forgot-password-email').value;
                const errorDiv = document.getElementById('forgot-password-error');
                const button = document.getElementById('forgot-password-btn');

                errorDiv.classList.add('hidden');

                if (!email) {
                    errorDiv.textContent = 'Por favor, insira o seu email para recuperar a senha.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                setButtonLoadingState(button, true, "A enviar...");

                sendPasswordResetEmail(auth, email)
                    .then(() => {
                         showInfoModal('Recuperação de Senha', 'Email de recuperação enviado! Verifique a sua caixa de entrada.');
                         forgotPasswordView.classList.add('hidden');
                         loginView.classList.remove('hidden');
                    })
                    .catch((error) => {
                        console.error('Erro ao enviar email de recuperação:', error);
                        errorDiv.textContent = 'Não foi possível enviar o email. Verifique se o email está correto.';
                        errorDiv.classList.remove('hidden');
                    })
                    .finally(() => {
                        setButtonLoadingState(button, false, 'Enviar Email de Recuperação');
                    });
            }
            
            function togglePasswordVisibility() {
                const passwordInput = document.getElementById('login-password');
                const toggleIcon = document.getElementById('password-toggle');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            }

            // --- INICIALIZAÇÃO FIREBASE ---
            function initFirebase() {
                try {
                    // IMPORTANTE: Para a autenticação funcionar, substitua a string abaixo
                    // pela sua chave de API do Firebase.
                    // IMPORTANT: For authentication to work, replace the string below
                    // with your Firebase API key.
                    const firebaseConfig = {
                        apiKey: "__REPLACE_WITH_YOUR_API_KEY__",
                        authDomain: "plataforma-gestao-narisrec.firebaseapp.com",
                        projectId: "plataforma-gestao-narisrec",
                        storageBucket: "plataforma-gestao-narisrec.appspot.com",
                        messagingSenderId: "176814130489",
                        appId: "1:176814130489:web:dc5e2e51afd274da0094e8",
                        measurementId: "G-B4NPG8M822"
                    };
                    
                    appId = firebaseConfig.appId;
                    
                    const app = initializeApp(firebaseConfig);
                    const analytics = getAnalytics(app);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    firebaseAuth();
                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    document.body.innerHTML = `<div class="fixed inset-0 flex items-center justify-center bg-red-100 text-red-700 p-8 text-center"><strong>Erro Crítico ao Inicializar Firebase:</strong> ${error.message}. Verifique a consola para mais detalhes.</div>`;
                }
            }
            
            async function firebaseAuth() {
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, 'artifacts', appId, 'public/data/utilizadores', user.uid);
                        const docSnap = await getDoc(userDocRef);

                        if (docSnap.exists() && docSnap.data().status === 'aprovado') {
                            userId = user.uid;
                            const userData = docSnap.data();
                            currentUserNome = userData.nome || user.email.split('@')[0];
                            currentUserRole = userData.funcao || 'Utilizador';

                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            appContainer.classList.add('flex');

                            document.getElementById('user-email').textContent = user.email;
                            document.getElementById('user-name').textContent = currentUserNome;
                            const userInitial = currentUserNome ? currentUserNome.charAt(0).toUpperCase() : 'U';
                            document.getElementById('user-avatar').src = `https://placehold.co/40x40/059669/ffffff?text=${userInitial}`;
                            
                            attachFirestoreListeners();
                        } else {
                            await signOut(auth);
                            const errorDiv = document.getElementById('login-error');
                            errorDiv.textContent = docSnap.exists() ? 'A sua conta aguarda aprovação.' : 'Utilizador não encontrado.';
                            errorDiv.classList.remove('hidden');
                        }
                    } else {
                        userId = null;
                        currentUserNome = '';
                        currentUserRole = 'Utilizador';
                        
                        authContainer.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                        appContainer.classList.remove('flex');
                        
                        detachFirestoreListeners();
                    }
                });
            }

            function attachFirestoreListeners() {
                if (!userId) return;

                const commonPath = `artifacts/${appId}/users/${userId}`;
                const publicPath = `artifacts/${appId}/public/data`;

                clientesUnsubscribe = onSnapshot(collection(db, commonPath, 'clientes'), snapshot => {
                    liveClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderClientes(liveClientes);
                    updateClienteDropdowns(liveClientes);
                }, err => console.error("Erro no listener de clientes:", err));

                produtosUnsubscribe = onSnapshot(collection(db, commonPath, 'produtos'), snapshot => {
                    liveProdutos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (liveProdutos.length === 0) seedProdutos();
                    renderProdutos(liveProdutos);
                }, err => console.error("Erro no listener de produtos:", err));

                equipamentosUnsubscribe = onSnapshot(collection(db, commonPath, 'equipamentos'), snapshot => {
                    liveEquipamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEquipamentos(liveEquipamentos);
                    applyFiltersAndRender(); 
                }, err => console.error("Erro no listener de equipamentos:", err));

                materiaPrimaUnsubscribe = onSnapshot(collection(db, commonPath, 'materiaPrima'), snapshot => {
                    liveMateriaPrima = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMateriaPrima(liveMateriaPrima);
                    applyFiltersAndRender();
                }, err => console.error("Erro no listener de matéria-prima:", err));
                
                ecopontoRegistosUnsubscribe = onSnapshot(collection(db, commonPath, 'ecoponto_registos'), snapshot => {
                    liveEcopontoRegistos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEcopontoRegistos(liveEcopontoRegistos);
                    applyFiltersAndRender();
                }, err => console.error("Erro no listener de registos do ecoponto:", err));

                utilizadoresUnsubscribe = onSnapshot(collection(db, publicPath, 'utilizadores'), snapshot => {
                    liveUtilizadores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUtilizadores(liveUtilizadores);
                }, err => console.error("Erro no listener de utilizadores:", err));
            }
            
            function detachFirestoreListeners() {
                if (clientesUnsubscribe) clientesUnsubscribe();
                if (produtosUnsubscribe) produtosUnsubscribe();
                if (equipamentosUnsubscribe) equipamentosUnsubscribe();
                if (materiaPrimaUnsubscribe) materiaPrimaUnsubscribe();
                if (utilizadoresUnsubscribe) utilizadoresUnsubscribe();
                if (ecopontoRegistosUnsubscribe) ecopontoRegistosUnsubscribe();
            }

            function setupEventListeners() {
                // Auth Toggles
                document.getElementById('show-register').addEventListener('click', (e) => {
                    e.preventDefault();
                    loginView.classList.add('hidden');
                    forgotPasswordView.classList.add('hidden');
                    registerView.classList.remove('hidden');
                });
                document.getElementById('show-login-from-register').addEventListener('click', (e) => {
                    e.preventDefault();
                    registerView.classList.add('hidden');
                    forgotPasswordView.classList.add('hidden');
                    loginView.classList.remove('hidden');
                });
                document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    loginView.classList.add('hidden');
                    registerView.classList.add('hidden');
                    forgotPasswordView.classList.remove('hidden');
                });
                document.getElementById('show-login-from-forgot').addEventListener('click', (e) => {
                    e.preventDefault();
                    forgotPasswordView.classList.add('hidden');
                    registerView.classList.add('hidden');
                    loginView.classList.remove('hidden');
                });

                // Auth Forms
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('register-form').addEventListener('submit', handleRegister);
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
                document.getElementById('password-toggle').addEventListener('click', togglePasswordVisibility);

                // Confirmation Modal
                document.getElementById('confirm-modal-confirm-btn').addEventListener('click', () => {
                    if (typeof onConfirmCallback === 'function') {
                        onConfirmCallback();
                    }
                    closeModal();
                });


                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavClick));
                document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', closeModal));
                window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(); });

                // Botões "Novo"
                document.getElementById('add-cliente-btn').addEventListener('click', handleNewCliente);
                document.getElementById('add-produto-btn').addEventListener('click', handleNewProduto);
                document.getElementById('add-equipamento-btn').addEventListener('click', handleNewEquipamento);
                document.getElementById('add-materia-prima-btn').addEventListener('click', handleNewMateriaPrima);
                document.getElementById('add-user-btn').addEventListener('click', handleNewUser);
                
                // Forms
                document.getElementById('cliente-form').addEventListener('submit', saveCliente);
                document.getElementById('produto-form').addEventListener('submit', saveProduto);
                document.getElementById('equipamento-form').addEventListener('submit', saveEquipamento);
                document.getElementById('materia-prima-form').addEventListener('submit', saveMateriaPrima);
                document.getElementById('user-form').addEventListener('submit', saveUser);
                document.getElementById('ecoponto-registo-form').addEventListener('submit', saveEcopontoRegisto);
                
                // Ações nas listas
                document.getElementById('clientes-list').addEventListener('click', handleClienteListClick);
                document.getElementById('produtos-list').addEventListener('click', handleProdutoListClick);
                document.getElementById('equipamentos-list').addEventListener('click', handleEquipamentoListClick);
                document.getElementById('materia-prima-list').addEventListener('click', handleMateriaPrimaListClick);
                document.getElementById('users-list').addEventListener('click', handleUserListClick);
                 document.getElementById('ecoponto-page').addEventListener('click', handleEcopontoListClick);
                
                // Modais dinâmicos
                document.getElementById('materia-prima-modal').addEventListener('input', e => { if (e.target.classList.contains('materia-prima-qty') || e.target.classList.contains('materia-prima-unit')) updateTotalPeso(); });
                document.getElementById('add-equipamento-item-btn').addEventListener('click', () => {
                    const tipoInput = document.getElementById('equipamento-item-tipo');
                    const marcaInput = document.getElementById('equipamento-item-marca');
                    const modeloInput = document.getElementById('equipamento-item-modelo');
                    const nserieInput = document.getElementById('equipamento-item-nserie');
                    const qtyInput = document.getElementById('equipamento-item-qty');

                    const qty = parseInt(qtyInput.value, 10) || 1;

                    if (!tipoInput.value.trim()) {
                        alert('O campo "Tipo" é obrigatório.');
                        return;
                    }

                    addEquipamentoToTable({
                        tipo: tipoInput.value,
                        marca: marcaInput.value,
                        modelo: modeloInput.value,
                        nSerie: nserieInput.value,
                        qty: qty
                    });

                    tipoInput.value = '';
                    marcaInput.value = '';
                    modeloInput.value = '';
                    nserieInput.value = '';
                    qtyInput.value = '1';
                });

                // Filtros
                document.getElementById('filter-btn').addEventListener('click', applyFiltersAndRender);
                document.getElementById('ecoponto-filter-btn').addEventListener('click', applyFiltersAndRender);
                document.getElementById('clear-filter-btn').addEventListener('click', () => {
                    document.getElementById('cliente-filter').value = 'todos';
                    document.getElementById('data-inicio').value = '';
                    document.getElementById('data-fim').value = '';
                    applyFiltersAndRender();
                });
                document.getElementById('ecoponto-clear-filter-btn').addEventListener('click', () => {
                    document.getElementById('ecoponto-cliente-filter').value = 'todos';
                    document.getElementById('ecoponto-data-inicio').value = '';
                    document.getElementById('ecoponto-data-fim').value = '';
                    applyFiltersAndRender();
                });
                
                // Relatório
                document.getElementById('generate-report-btn').addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    setButtonLoadingState(btn, true, "Gerando...");
                    generateReport().finally(() => setButtonLoadingState(btn, false, "Gerar PDF"));
                });

                setupEquipamentoSearch();
            }

            // --- INICIALIZAÇÃO GERAL ---
            function init() {
                initFirebase();
                setupEventListeners();
                document.getElementById('copyright-year').textContent = new Date().getFullYear();
                createCharts();
                 // Initialize button original text
                document.querySelectorAll('button[type="submit"], #generate-report-btn').forEach(btn => {
                    btn.dataset.originalText = btn.innerHTML;
                });
            }

            // --- LÓGICA DE FILTROS E RENDERIZAÇÃO DE DASHBOARDS ---
            function applyFiltersAndRender() {
                const dashboardActive = document.getElementById('dashboard-page').classList.contains('active');
                const ecopontoActive = document.getElementById('ecoponto-page').classList.contains('active');
                
                if (dashboardActive) {
                    const clienteId = document.getElementById(`cliente-filter`)?.value;
                    const startDate = document.getElementById(`data-inicio`)?.value;
                    const endDate = document.getElementById(`data-fim`)?.value;

                    const filterPredicate = item => {
                        const clienteMatch = !clienteId || clienteId === 'todos' || item.clienteId === clienteId;
                        const startDateMatch = !startDate || new Date(item.dataInicio) >= new Date(startDate);
                        const endDateMatch = !endDate || new Date(item.dataInicio) <= new Date(endDate);
                        return clienteMatch && startDateMatch && endDateMatch;
                    };

                    const filteredEquipamentos = liveEquipamentos.filter(filterPredicate);
                    const filteredMateriaPrima = liveMateriaPrima.filter(filterPredicate);
                    updateDashboardUI(filteredEquipamentos, filteredMateriaPrima, false);
                }
                
                if (ecopontoActive) {
                     const clienteId = document.getElementById(`ecoponto-cliente-filter`)?.value;
                    const startDate = document.getElementById(`ecoponto-data-inicio`)?.value;
                    const endDate = document.getElementById(`ecoponto-data-fim`)?.value;

                    const filterPredicate = item => {
                        const clienteMatch = !clienteId || clienteId === 'todos' || item.clienteId === clienteId;
                        const startDateMatch = !startDate || new Date(item.data) >= new Date(startDate);
                        const endDateMatch = !endDate || new Date(item.data) <= new Date(endDate);
                        return clienteMatch && startDateMatch && endDateMatch;
                    };
                    const filteredEcopontoRegistos = liveEcopontoRegistos.filter(filterPredicate);
                    updateDashboardUI(filteredEcopontoRegistos, filteredEcopontoRegistos, true);
                }
            }

            function updateDashboardUI(equipamentosSource, materiaPrimaSource, isEcoponto) {
                if (isEcoponto) {
                    updateEcopontoDashboard(equipamentosSource); // Passa a fonte única de dados
                } else {
                    updateMainDashboard(equipamentosSource, materiaPrimaSource);
                }
            }
            
            // --- FUNÇÕES DE RENDERIZAÇÃO (LISTAS) ---
            function renderClientes(clientes) {
                const list = document.getElementById('clientes-list');
                list.innerHTML = clientes.map(c => `
                    <tr class="border-b">
                        <td class="p-3">${c.nome}</td>
                        <td class="p-3">${c.nif}</td>
                        <td class="p-3">${c.tipo || ''}</td>
                        <td class="p-3">${c.contacto || ''}</td>
                        <td class="p-3">${c.email || ''}</td>
                        <td class="p-3">
                            <button class="edit-cliente text-blue-500 mr-2" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-cliente text-red-500" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }

            function renderProdutos(produtos) {
                const list = document.getElementById('produtos-list');
                list.innerHTML = produtos.map(p => `
                    <tr class="border-b">
                        <td class="p-3">${p.id.substring(0, 5)}...</td>
                        <td class="p-3">${p.nome}</td>
                        <td class="p-3">${p.categoria}</td>
                        <td class="p-3">${p.origem || ''}</td>
                        <td class="p-3">
                            <button class="edit-produto text-blue-500 mr-2" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-produto text-red-500" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }
            
            function renderEquipamentos(equipamentos) {
                const list = document.getElementById('equipamentos-list');
                list.innerHTML = equipamentos.map(i => `
                    <tr class="border-b">
                        <td class="p-3">${i.refRecolha}</td> <td class="p-3">${i.clienteNome}</td> <td class="p-3">${i.dataInicio}</td> <td class="p-3">${i.origem}</td>
                        <td class="p-3">${i.responsavelNome || 'N/A'}</td>
                        <td class="p-3">
                            <button class="edit-equipamento text-blue-500 mr-2" data-id="${i.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-equipamento text-red-500" data-id="${i.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }

            function renderMateriaPrima(materiaPrima) {
                const list = document.getElementById('materia-prima-list');
                list.innerHTML = materiaPrima.map(mp => `
                    <tr class="border-b">
                        <td class="p-3">${mp.refRecolha}</td> <td class="p-3">${mp.clienteNome}</td> <td class="p-3">${mp.dataInicio}</td> <td class="p-3">${mp.origem}</td>
                        <td class="p-3">${mp.responsavelNome || 'N/A'}</td>
                        <td class="p-3">
                            <button class="edit-materia-prima text-blue-500 mr-2" data-id="${mp.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-materia-prima text-red-500" data-id="${mp.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }

            function renderUtilizadores(utilizadores) {
                const list = document.getElementById('users-list');
                 list.innerHTML = utilizadores.map(u => {
                    const isAdmin = currentUserRole === 'Admin';
                    const statusClass = u.status === 'pendente' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800';
                    let actions = '';

                    if (isAdmin) {
                        if (u.status === 'pendente') {
                             actions = `<button class="approve-user text-green-500 mr-2" data-id="${u.id}" title="Aprovar"><i class="fas fa-check-circle"></i></button>`;
                        } else {
                            actions = `<button class="edit-user text-blue-500 mr-2" data-id="${u.id}" title="Editar"><i class="fas fa-edit"></i></button>`;
                        }
                        actions += `<button class="delete-user text-red-500" data-id="${u.id}" title="Apagar"><i class="fas fa-trash"></i></button>`;
                    }

                    return `
                        <tr class="border-b">
                            <td class="p-3">${u.nome}</td>
                            <td class="p-3">${u.email}</td>
                            <td class="p-3">${u.funcao}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${u.status}</span></td>
                            <td class="p-3">${actions}</td>
                        </tr>`;
                }).join('');
            }

            function renderEcopontoRegistos(registos) {
                const list = document.getElementById('ecoponto-registos-list');
                if (!list) return;

                list.innerHTML = registos.map(reg => {
                    const totalMP = Object.values(reg.materiasPrimas || {}).reduce((sum, val) => sum + val, 0);
                    const totalEquip = (reg.equipamentos || []).reduce((sum, item) => sum + item.qty, 0);

                    return `
                        <tr class="border-b">
                            <td class="p-3">${reg.id.substring(0, 8)}...</td>
                            <td class="p-3">${reg.data}</td>
                            <td class="p-3">${reg.clienteNome}</td>
                            <td class="p-3">${reg.responsavelNome || 'N/A'}</td>
                            <td class="p-3">${totalMP.toFixed(2)} kg</td>
                            <td class="p-3">${totalEquip}</td>
                            <td class="p-3">
                                <button class="edit-ecoponto text-blue-500 mr-2" data-id="${reg.id}" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="delete-ecoponto text-red-500" data-id="${reg.id}" title="Apagar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // --- FUNÇÕES DE DASHBOARD ---
            function formatWeight(kg) {
                if (kg >= 1000) {
                    return `${(kg / 1000).toFixed(2)} t`;
                }
                return `${kg.toFixed(2)} kg`;
            }

            function updateMainDashboard(equipamentosData, materiaPrimaData) {
                 const totalRecolhas = equipamentosData.length + materiaPrimaData.length;
                const totalMateriaPrimaKg = materiaPrimaData.reduce((sum, item) => sum + (item.pesoTotal || 0), 0);
                
                let totalEquipamentosUnidades = 0;
                equipamentosData.forEach(reg => {
                    totalEquipamentosUnidades += (reg.items || []).reduce((sum, item) => sum + (item.qty || 1), 0);
                });

                const totalEquipamentosPeso = equipamentosData.reduce((sum, item) => sum + (parseFloat(item.pesoTotal) || 0), 0);
                const totalResiduosKg = totalMateriaPrimaKg + totalEquipamentosPeso;
                const totalCo2Evitado = totalMateriaPrimaKg * 1.5;

                document.getElementById('stat-recolhas').textContent = totalRecolhas;
                document.getElementById('stat-residuos').textContent = formatWeight(totalResiduosKg);
                document.getElementById('stat-equipamentos').textContent = totalEquipamentosUnidades;
                document.getElementById('stat-materia-prima').textContent = formatWeight(totalMateriaPrimaKg);
                document.getElementById('stat-co2').textContent = formatWeight(totalCo2Evitado);

                // Top Tables (Main Dashboard)
                const equipAggr = {};
                equipamentosData.forEach(reg => { (reg.items || []).forEach(item => {
                    const tipo = item.tipo || item.nome; // Compatibilidade com dados antigos
                    equipAggr[tipo] = (equipAggr[tipo] || 0) + (item.qty || 1); 
                }); });
                const topEquipamentos = Object.entries(equipAggr).sort((a, b) => b[1] - a[1]).slice(0, 10);
                document.getElementById('top-equipamentos-body').innerHTML = topEquipamentos.map(([nome, qtd]) => `<tr><td class="p-2">${nome}</td><td class="p-2 text-right">${qtd}</td></tr>`).join('');

                const materiaAggr = {};
                materiaPrimaData.forEach(reg => { (reg.quantidades || []).forEach(item => { const pesoKg = item.unit === 't' ? item.qty * 1000 : item.qty; materiaAggr[item.nome] = (materiaAggr[item.nome] || 0) + pesoKg; }); });
                const topMateriaPrima = Object.entries(materiaAggr).sort((a, b) => b[1] - a[1]).slice(0, 10);
                document.getElementById('top-materia-prima-body').innerHTML = topMateriaPrima.map(([nome, peso]) => `<tr><td class="p-2">${nome}</td><td class="p-2 text-right">${formatWeight(peso)}</td></tr>`).join('');
                
                 updateCharts(equipamentosData, materiaPrimaData);
            }

            function updateEcopontoDashboard(registosEcoponto) {
                 const totalRecolhas = registosEcoponto.length;
                let totalEquipamentosUnidades = 0;
                let totalMateriaPrimaKg = 0;
                const equipAggr = {};
                const materiaAggr = {};

                registosEcoponto.forEach(reg => {
                    (reg.equipamentos || []).forEach(item => {
                        totalEquipamentosUnidades += item.qty;
                        equipAggr[item.nome] = (equipAggr[item.nome] || 0) + item.qty;
                    });
                    Object.entries(reg.materiasPrimas || {}).forEach(([nome, peso]) => {
                        totalMateriaPrimaKg += peso;
                        materiaAggr[nome] = (materiaAggr[nome] || 0) + peso;
                    });
                });

                const totalCo2Evitado = totalMateriaPrimaKg * 1.5;

                document.getElementById('stat-recolhas-ecoponto').textContent = totalRecolhas;
                document.getElementById('stat-residuos-ecoponto').textContent = formatWeight(totalMateriaPrimaKg); // Apenas MP tem peso
                document.getElementById('stat-equipamentos-ecoponto').textContent = totalEquipamentosUnidades;
                document.getElementById('stat-materia-prima-ecoponto').textContent = formatWeight(totalMateriaPrimaKg);
                document.getElementById('stat-co2-ecoponto').textContent = formatWeight(totalCo2Evitado);

                const topEquipEcoponto = Object.entries(equipAggr).sort((a, b) => b[1] - a[1]).slice(0, 10);
                document.getElementById('ecoponto-top-equipamentos-body').innerHTML = topEquipEcoponto.map(([nome, qtd]) => `<tr><td class="p-2">${nome}</td><td class="p-2 text-right">${qtd}</td></tr>`).join('');

                const topMateriaEcoponto = Object.entries(materiaAggr).sort((a, b) => b[1] - a[1]).slice(0, 10);
                document.getElementById('ecoponto-top-materia-prima-body').innerHTML = topMateriaEcoponto.map(([nome, peso]) => `<tr><td class="p-2">${nome}</td><td class="p-2 text-right">${formatWeight(peso)}</td></tr>`).join('');
            }
            
            // Funções CRUD (saveCliente, saveProduto, etc.) e outras auxiliares
             function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
            function closeModal() { 
                document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                onConfirmCallback = null; // Reset callback
            }

            function showConfirmationModal(title, body, onConfirm) {
                document.getElementById('confirm-modal-title').textContent = title || 'Confirmar Ação';
                document.getElementById('confirm-modal-body').textContent = body || 'Tem a certeza que quer apagar este registo? Esta ação não pode ser desfeita.';
                onConfirmCallback = onConfirm;
                openModal('confirm-modal');
            }
            
            function showInfoModal(title, body) {
                document.getElementById('info-modal-title').textContent = title;
                document.getElementById('info-modal-body').textContent = body;
                openModal('info-modal');
            }


            // --- LÓGICA DE CRUD (CLIENTES) ---
            function handleNewCliente() {
                document.getElementById('cliente-modal-title').textContent = 'Novo Cliente';
                document.getElementById('cliente-form').reset();
                document.getElementById('cliente-id').value = '';
                openModal('cliente-modal');
            }

            async function saveCliente(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);
                const id = document.getElementById('cliente-id').value;
                const data = { 
                    nome: document.getElementById('cliente-nome').value, 
                    nif: document.getElementById('cliente-nif').value,
                    tipo: document.getElementById('cliente-tipo').value,
                    contacto: document.getElementById('cliente-contacto').value, 
                    email: document.getElementById('cliente-email').value 
                };
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'clientes');
                try {
                    if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                    } else {
                        await addDoc(collectionRef, data);
                    }
                    closeModal();
                } catch (error) {
                    console.error("Erro ao salvar cliente:", error);
                } finally {
                    setButtonLoadingState(button, false);
                }
            }

            async function handleClienteListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'clientes');

                if (target.classList.contains('edit-cliente')) {
                    const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const cliente = docSnap.data();
                        document.getElementById('cliente-modal-title').textContent = 'Editar Cliente';
                        document.getElementById('cliente-id').value = id;
                        document.getElementById('cliente-nome').value = cliente.nome;
                        document.getElementById('cliente-nif').value = cliente.nif;
                        document.getElementById('cliente-tipo').value = cliente.tipo || 'Produção';
                        document.getElementById('cliente-contacto').value = cliente.contacto;
                        document.getElementById('cliente-email').value = cliente.email;
                        openModal('cliente-modal');
                    }
                }
                if (target.classList.contains('delete-cliente')) {
                     showConfirmationModal('Apagar Cliente', `Tem a certeza que quer apagar este cliente?`, async () => {
                        await deleteDoc(doc(collectionRef, id));
                    });
                }
            }

            // --- LÓGICA DE CRUD (PRODUTOS) ---
            function handleNewProduto() {
                document.getElementById('produto-modal-title').textContent = 'Novo Produto';
                document.getElementById('produto-form').reset();
                document.getElementById('produto-id').value = '';
                openModal('produto-modal');
            }

            async function saveProduto(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);
                const id = document.getElementById('produto-id').value;
                const data = { 
                    nome: document.getElementById('produto-nome').value, 
                    categoria: document.getElementById('produto-categoria').value,
                    origem: document.getElementById('produto-origem').value
                };
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'produtos');

                try {
                     if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                    } else {
                        await addDoc(collectionRef, data);
                    }
                    closeModal();
                } catch(error) {
                    console.error("Erro ao salvar produto:", error);
                } finally {
                    setButtonLoadingState(button, false);
                }
            }

            async function handleProdutoListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'produtos');
                
                if (target.classList.contains('edit-produto')) {
                     const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const produto = docSnap.data();
                        document.getElementById('produto-modal-title').textContent = 'Editar Produto';
                        document.getElementById('produto-id').value = id;
                        document.getElementById('produto-nome').value = produto.nome;
                        document.getElementById('produto-categoria').value = produto.categoria;
                        document.getElementById('produto-origem').value = produto.origem || 'Produção';
                        openModal('produto-modal');
                    }
                }
                if (target.classList.contains('delete-produto')) {
                    showConfirmationModal('Apagar Produto', `Tem a certeza que quer apagar este produto?`, async () => {
                       await deleteDoc(doc(collectionRef, id));
                    });
                }
            }

            // --- LÓGICA DE CRUD (UTILIZADORES) ---
            function handleNewUser() {
                 if (currentUserRole !== 'Admin') {
                    alert('Apenas administradores podem adicionar novos utilizadores.');
                    return;
                }
                document.getElementById('user-modal-title').textContent = 'Novo Utilizador';
                document.getElementById('user-form').reset();
                document.getElementById('user-id').value = '';
                openModal('user-modal');
            }
            
            async function saveUser(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);

                const id = document.getElementById('user-id').value;
                const data = { 
                    nome: document.getElementById('user-nome').value, 
                    email: document.getElementById('user-email').value, 
                    funcao: document.getElementById('user-funcao').value,
                };
                const collectionRef = collection(db, 'artifacts', appId, 'public/data/utilizadores');
                
                try {
                     if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                    } else {
                        alert('Funcionalidade para admin criar utilizadores com login ainda não implementada.');
                    }
                    closeModal();
                } catch(error) {
                    console.error("Erro ao salvar utilizador:", error);
                } finally {
                    setButtonLoadingState(button, false);
                }
            }

            async function handleUserListClick(e) {
                const target = e.target.closest('button');
                if (!target || currentUserRole !== 'Admin') return;
                
                const id = target.dataset.id;
                const collectionRef = collection(db, 'artifacts', appId, 'public/data/utilizadores');
                
                if (target.classList.contains('approve-user')) {
                    await updateDoc(doc(collectionRef, id), { status: 'aprovado' });
                }
                
                if (target.classList.contains('edit-user')) {
                     const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const user = docSnap.data();
                        document.getElementById('user-modal-title').textContent = 'Editar Utilizador';
                        document.getElementById('user-id').value = id;
                        document.getElementById('user-nome').value = user.nome;
                        document.getElementById('user-email').value = user.email;
                        document.getElementById('user-funcao').value = user.funcao;
                        openModal('user-modal');
                    }
                }
                if (target.classList.contains('delete-user')) {
                    showConfirmationModal('Apagar Utilizador', `Tem a certeza que quer apagar este utilizador? Esta ação não pode ser desfeita e irá apagar a conta de login.`, async () => {
                       await deleteDoc(doc(collectionRef, id));
                       alert('Utilizador apagado da lista. A conta de login precisa ser removida manually na consola Firebase.');
                    });
                }
            }
            
            
            function setupEquipamentoSearch() {
                const searchInput = document.getElementById('equipamento-item-tipo');
                const searchResultsContainer = document.getElementById('equipamento-tipo-results');
                
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase();
                    if (query.length < 2) {
                        searchResultsContainer.innerHTML = '';
                        searchResultsContainer.classList.add('hidden');
                        return;
                    }

                    const equipamentosDisponiveis = liveProdutos.filter(p => p.categoria === 'Equipamento' && p.origem === 'Produção');
                    const filtered = equipamentosDisponiveis.filter(p => p.nome.toLowerCase().includes(query));
                    
                    if (filtered.length > 0) {
                        searchResultsContainer.innerHTML = filtered.map(p => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-nome="${p.nome}">${p.nome}</div>`).join('');
                        searchResultsContainer.classList.remove('hidden');
                    } else {
                        searchResultsContainer.classList.add('hidden');
                    }
                });

                searchResultsContainer.addEventListener('click', (e) => {
                    if (e.target.dataset.nome) {
                        searchInput.value = e.target.dataset.nome;
                        searchResultsContainer.classList.add('hidden');
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                        searchResultsContainer.classList.add('hidden');
                    }
                });
            }

            function addEquipamentoToTable(item) {
                const list = document.getElementById('equipamentos-adicionados-list');
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-2">${item.tipo}</td>
                    <td class="p-2">${item.marca}</td>
                    <td class="p-2">${item.modelo}</td>
                    <td class="p-2">${item.qty}</td>
                    <td class="p-2">${item.nSerie}</td>
                    <td class="p-2">
                        <button type="button" class="remove-equipamento-item text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                list.appendChild(row);

                row.querySelector('.remove-equipamento-item').addEventListener('click', () => {
                    row.remove();
                    updateTotalUnidades();
                });

                updateTotalUnidades();
            }

            function updateTotalUnidades() {
                let total = 0;
                const rows = document.getElementById('equipamentos-adicionados-list').rows;
                for (let row of rows) {
                    total += parseInt(row.cells[3].textContent) || 0;
                }
                document.getElementById('equipamento-total-unidades').textContent = total;
            }
            
            async function handleNewEquipamento() {
                document.getElementById('equipamento-modal-title').textContent = 'Novo Registo de Equipamento';
                document.getElementById('equipamento-form').reset();
                document.getElementById('equipamento-id').value = '';
                document.getElementById('equipamentos-adicionados-list').innerHTML = '';
                updateTotalUnidades();
                openModal('equipamento-modal');
            }
            
            async function saveEquipamento(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);

                const id = document.getElementById('equipamento-id').value;
                const select = document.getElementById('equipamento-cliente-select');
                const data = {
                    refRecolha: document.getElementById('ref-recolha-equipamento').value,
                    lote: document.getElementById('equipamento-lote').value,
                    clienteId: select.value,
                    clienteNome: select.options[select.selectedIndex].text,
                    dataInicio: document.getElementById('equipamento-data-inicio').value,
                    dataFim: document.getElementById('equipamento-data-fim').value,
                    origem: document.getElementById('equipamento-origem').value,
                    pesoTotal: document.getElementById('equipamento-peso-total').value,
                    observacoes: document.getElementById('equipamento-observacoes').value,
                    responsavelNome: currentUserNome,
                    responsavelId: userId,
                    items: []
                };

                const rows = document.getElementById('equipamentos-adicionados-list').rows;
                for (let row of rows) {
                    data.items.push({
                        tipo: row.cells[0].textContent,
                        marca: row.cells[1].textContent,
                        modelo: row.cells[2].textContent,
                        qty: parseInt(row.cells[3].textContent) || 1,
                        nSerie: row.cells[4].textContent,
                    });
                }
                data.totalUnidades = data.items.reduce((sum, item) => sum + item.qty, 0);
                
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'equipamentos');
                try {
                    if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                    } else {
                        await addDoc(collectionRef, data);
                    }
                    closeModal();
                } catch(error) {
                    console.error("Erro ao salvar equipamento:", error);
                } finally {
                    setButtonLoadingState(button, false);
                }
            }

             async function handleEquipamentoListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'equipamentos');

                if (target.classList.contains('edit-equipamento')) {
                    const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('equipamento-modal-title').textContent = 'Editar Registo de Equipamento';
                        document.getElementById('equipamento-id').value = id;
                        document.getElementById('ref-recolha-equipamento').value = data.refRecolha;
                        document.getElementById('equipamento-lote').value = data.lote || '';
                        document.getElementById('equipamento-cliente-select').value = data.clienteId;
                        document.getElementById('equipamento-data-inicio').value = data.dataInicio;
                        document.getElementById('equipamento-data-fim').value = data.dataFim || '';
                        document.getElementById('equipamento-origem').value = data.origem;
                        document.getElementById('equipamento-peso-total').value = data.pesoTotal;
                        document.getElementById('equipamento-observacoes').value = data.observacoes;
                        
                        const list = document.getElementById('equipamentos-adicionados-list');
                        list.innerHTML = '';
                        (data.items || []).forEach(item => addEquipamentoToTable(item));
                        updateTotalUnidades();
                        openModal('equipamento-modal');
                    }
                }
                if (target.classList.contains('delete-equipamento')) {
                    showConfirmationModal('Apagar Registo', `Tem a certeza que quer apagar este registo de equipamento?`, async () => {
                        await deleteDoc(doc(collectionRef, id));
                    });
                }
            }


            async function handleNewMateriaPrima() {
                document.getElementById('materia-prima-modal-title').textContent = 'Novo Registo de Matéria-Prima';
                document.getElementById('materia-prima-form').reset();
                 document.getElementById('materia-prima-id').value = '';
                await renderMateriaPrimaRows();
                openModal('materia-prima-modal');
            }
            
            async function saveMateriaPrima(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);
                const id = document.getElementById('materia-prima-id').value;
                const select = document.getElementById('materia-prima-cliente-select');
                const data = {
                    refRecolha: document.getElementById('ref-recolha-materia').value,
                    lote: document.getElementById('materia-prima-lote').value,
                    clienteId: select.value,
                    clienteNome: select.options[select.selectedIndex].text,
                    dataInicio: document.getElementById('materia-prima-data-inicio').value,
                    dataFim: document.getElementById('materia-prima-data-fim').value,
                    origem: document.getElementById('materia-prima-origem').value,
                    responsavelNome: currentUserNome,
                    responsavelId: userId,
                    quantidades: [],
                    pesoTotal: 0
                };

                let totalKg = 0;
                document.querySelectorAll('.materia-prima-card').forEach(card => {
                    const qtyInput = card.querySelector('.materia-prima-qty');
                    const unitSelect = card.querySelector('.materia-prima-unit');
                    const qty = parseFloat(qtyInput.value) || 0;
                    
                    if (qty > 0) {
                        const nome = qtyInput.dataset.nome;
                        const unit = unitSelect.value;
                        data.quantidades.push({ nome, qty, unit });
                        totalKg += (unit === 't') ? qty * 1000 : qty;
                    }
                });
                data.pesoTotal = totalKg;
                
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'materiaPrima');
                try {
                     if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                    } else {
                        await addDoc(collectionRef, data);
                    }
                    closeModal();
                } catch (error) {
                     console.error("Erro ao salvar matéria-prima:", error);
                } finally {
                    setButtonLoadingState(button, false);
                }
            }

            async function handleMateriaPrimaListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'materiaPrima');

                if (target.classList.contains('edit-materia-prima')) {
                    const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('materia-prima-modal-title').textContent = 'Editar Registo de Matéria-Prima';
                        document.getElementById('materia-prima-id').value = id;
                        document.getElementById('ref-recolha-materia').value = data.refRecolha;
                        document.getElementById('materia-prima-lote').value = data.lote || '';
                        document.getElementById('materia-prima-cliente-select').value = data.clienteId;
                        document.getElementById('materia-prima-data-inicio').value = data.dataInicio;
                        document.getElementById('materia-prima-data-fim').value = data.dataFim || '';
                        document.getElementById('materia-prima-origem').value = data.origem;
                        
                        await renderMateriaPrimaRows();
                         if(data.quantidades && Array.isArray(data.quantidades)) {
                            data.quantidades.forEach(item => {
                                const input = document.querySelector(`.materia-prima-qty[data-nome="${item.nome}"]`);
                                const select = document.querySelector(`.materia-prima-card:has(.materia-prima-qty[data-nome="${item.nome}"]) .materia-prima-unit`);
                                if (input) input.value = item.qty;
                                if (select) select.value = item.unit;
                            });
                        }
                        updateTotalPeso();
                        openModal('materia-prima-modal');
                    }
                }
                if (target.classList.contains('delete-materia-prima')) {
                    showConfirmationModal('Apagar Registo', `Tem a certeza que quer apagar este registo de matéria-prima?`, async () => {
                        await deleteDoc(doc(collectionRef, id));
                    });
                }
            }


            async function renderMateriaPrimaRows() {
                const container = document.getElementById('materia-prima-quantidades-container');
                const materiasPrimasDisponiveis = liveProdutos.filter(p => p.categoria === 'Matéria-prima' && p.origem === 'Produção');
                container.innerHTML = materiasPrimasDisponiveis.map(mp => `
                    <div class="materia-prima-card border rounded-lg p-3 shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-1">${mp.nome}</label>
                        <div class="flex gap-2">
                            <input type="number" step="0.01" data-nome="${mp.nome}" class="materia-prima-qty w-2/3 border rounded p-1" placeholder="0.00">
                            <select class="materia-prima-unit w-1/3 border rounded p-1 text-sm">
                                <option value="kg">Kg</option>
                                <option value="t">Ton</option>
                            </select>
                        </div>
                    </div>
                `).join('');
                updateTotalPeso();
            }

            function updateTotalPeso() {
                let total = 0;
                document.querySelectorAll('.materia-prima-card').forEach(card => {
                    const qtyInput = card.querySelector('.materia-prima-qty');
                    const unitSelect = card.querySelector('.materia-prima-unit');
                    let qty = parseFloat(qtyInput.value) || 0;
                    
                    if (unitSelect.value === 't') {
                        qty = qty * 1000; // Convert tonnes to kg
                    }
                    total += qty;
                });
                document.getElementById('materia-prima-peso-total').textContent = total.toFixed(2);
            }

            // --- LÓGICA DE RELATÓRIOS ---

            function drawFooter(doc, pageNum, pageCount) {
                doc.setFontSize(8);
                const footerText = \`Página \${pageNum} de \${pageCount}\`;
                doc.text(footerText, 196, 290, { align: 'right' });
            }

            function drawSummaryCards(doc, totalResiduosKg, totalEquipUnid, totalMateriaPrimaKg, totalCo2EvitadoKg) {
                const drawCard = (x, y, title, value, unit) => {
                    doc.setDrawColor(229, 231, 235); // gray-200
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(x, y, 45, 25, 3, 3, 'FD');
                    doc.setFontSize(10);
                    doc.setTextColor(107, 114, 128); // gray-500
                    doc.text(title, x + 22.5, y + 7, { align: 'center' });
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(31, 41, 55); // gray-800
                    doc.text(value, x + 22.5, y + 16, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(unit, x + 22.5, y + 21, { align: 'center' });
                };

                drawCard(14, 60, 'Resíduos Recolhidos', formatWeight(totalResiduosKg).split(' ')[0], formatWeight(totalResiduosKg).split(' ')[1]);
                drawCard(62, 60, 'Equipamentos', totalEquipUnid.toString(), 'unid.');
                drawCard(110, 60, 'Matéria-Prima', formatWeight(totalMateriaPrimaKg).split(' ')[0], formatWeight(totalMateriaPrimaKg).split(' ')[1]);
                drawCard(158, 60, 'CO₂e Evitado', formatWeight(totalCo2EvitadoKg).split(' ')[0], formatWeight(totalCo2EvitadoKg).split(' ')[1]);
            }
                const doc = new window.jspdf.jsPDF();
                
                const addHeader = (doc) => {
                    if (logoBase64) {
                        doc.addImage(logoBase64, 'PNG', 14, 12, 40, 12);
                    }
                    doc.setFontSize(22);
                    doc.setFont(undefined, 'bold');
                    doc.text('Relatório de Sustentabilidade', 105, 20, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Narisrec – Gestão de Resíduos, Lda.', 105, 26, { align: 'center' });
                };

                const addFooter = (doc, pageNum, pageCount) => {
                    doc.setFontSize(8);
                    const footerText = `Página ${pageNum} de ${pageCount}`;
                    doc.text(footerText, 196, 290, { align: 'right' });
                };

                
                const clienteId = document.getElementById('report-cliente-filter').value;
                const startDate = document.getElementById('report-data-inicio').value;
                const endDate = document.getElementById('report-data-fim').value;
                const clienteNome = clienteId === 'todos' ? 'Todos os Clientes' : document.getElementById('report-cliente-filter').options[document.getElementById('report-cliente-filter').selectedIndex].text;
                
                const filterPredicate = (item) => {
                    const date = item.dataInicio || item.data;
                    const clienteMatch = !clienteId || clienteId === 'todos' || item.clienteId === clienteId;
                    const startDateMatch = !startDate || new Date(date) >= new Date(startDate);
                    const endDateMatch = !endDate || new Date(date) <= new Date(endDate);
                    return clienteMatch && startDateMatch && endDateMatch;
                };

                const filteredEquipamentos = liveEquipamentos.filter(filterPredicate);
                const filteredMateriaPrima = liveMateriaPrima.filter(filterPredicate);
                const filteredEcoponto = liveEcopontoRegistos.filter(filterPredicate);
                
                let totalEquipUnid = filteredEquipamentos.reduce((sum, item) => sum + (item.totalUnidades || 0), 0);
                let totalMateriaPrimaKg = filteredMateriaPrima.reduce((sum, item) => sum + (item.pesoTotal || 0), 0);
                let totalResiduosKg = filteredEquipamentos.reduce((sum, item) => sum + (parseFloat(item.pesoTotal) || 0), 0) + totalMateriaPrimaKg;
                
                filteredEcoponto.forEach(reg => {
                    totalEquipUnid += (reg.equipamentos || []).reduce((sum, item) => sum + item.qty, 0);
                    const mpKg = Object.values(reg.materiasPrimas || {}).reduce((sum, val) => sum + val, 0);
                    totalMateriaPrimaKg += mpKg;
                    totalResiduosKg += mpKg;
                });
                
                const totalCo2EvitadoKg = totalMateriaPrimaKg * 1.5;


                addHeader(doc);
                doc.setFontSize(11);
                doc.text(`Cliente: ${clienteNome}`, 14, 40);
                doc.text(`Período: ${startDate || 'Início'} a ${endDate || 'Fim'}`, 14, 46);
                doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-PT')}`, 14, 52);


                const drawCard = (x, y, title, value, unit) => {
                    doc.setDrawColor(229, 231, 235); // gray-200
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(x, y, 45, 25, 3, 3, 'FD');
                    doc.setFontSize(10);
                    doc.setTextColor(107, 114, 128); // gray-500
                    doc.text(title, x + 22.5, y + 7, { align: 'center' });
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(31, 41, 55); // gray-800
                    doc.text(value, x + 22.5, y + 16, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(unit, x + 22.5, y + 21, { align: 'center' });
                };

                drawCard(14, 60, 'Resíduos Recolhidos', formatWeight(totalResiduosKg).split(' ')[0], formatWeight(totalResiduosKg).split(' ')[1]);
                drawCard(62, 60, 'Equipamentos', totalEquipUnid.toString(), 'unid.');
                drawCard(110, 60, 'Matéria-Prima', formatWeight(totalMateriaPrimaKg).split(' ')[0], formatWeight(totalMateriaPrimaKg).split(' ')[1]);
                drawCard(158, 60, 'CO₂e Evitado', formatWeight(totalCo2EvitadoKg).split(' ')[0], formatWeight(totalCo2EvitadoKg).split(' ')[1]);

                let y = 100;

                // Gráfico
                const materiaPrimaAggr = {};
                filteredEcoponto.forEach(reg => {
                    Object.entries(reg.materiasPrimas || {}).forEach(([nome, peso]) => {
                        materiaPrimaAggr[nome] = (materiaPrimaAggr[nome] || 0) + peso;
                    });
                });
                
                if (Object.keys(materiaPrimaAggr).length > 0) {
                    const chartCanvas = document.createElement('canvas');
                    chartCanvas.width = 400; chartCanvas.height = 400;
                    const chartCtx = chartCanvas.getContext('2d');
                    new Chart(chartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(materiaPrimaAggr),
                            datasets: [{
                                data: Object.values(materiaPrimaAggr),
                                backgroundColor: ['#059669', '#10B981', '#34D399', '#6EE7B7'],
                            }]
                        },
                        options: {
                            responsive: false,
                            animation: { duration: 0 },
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                            }
                        }
                    });

                    // Pequeno atraso para garantir que o gráfico é renderizado antes de ser convertido em imagem
                    await new Promise(resolve => setTimeout(resolve, 500)); 

                    const chartImage = chartCanvas.toDataURL('image/png');
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Composição da Matéria-Prima', 14, y);
                    doc.addImage(chartImage, 'PNG', 14, y + 5, 70, 70);
                }


                // Top Equipamentos
                const equipAggr = {};
                [...filteredEquipamentos, ...filteredEcoponto].forEach(reg => { 
                    (reg.items || reg.equipamentos || []).forEach(item => {
                        const tipo = item.tipo || item.nome;
                        const qty = item.qty || 1;
                        equipAggr[tipo] = (equipAggr[tipo] || 0) + qty; 
                    }); 
                });
                const topEquipamentos = Object.entries(equipAggr).sort((a,b) => b[1] - a[1]).slice(0, 10);
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Top Equipamentos', 110, y);
                doc.autoTable({
                    startY: y + 5,
                    head: [['Equipamento', 'Unidades']],
                    body: topEquipamentos,
                    theme: 'grid',
                    headStyles: { fillColor: [6, 78, 59] },
                    margin: { left: 110 }
                });
                
                y = doc.autoTable.previous.finalY + 15;


                // Registos Ecoponto
                if (filteredEcoponto.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Registos de Ecoponto', 14, y);
                    const ecopontoBody = filteredEcoponto.map(reg => {
                        const totalMP = Object.values(reg.materiasPrimas || {}).reduce((s,v) => s + v, 0);
                        const totalEq = (reg.equipamentos || []).reduce((s,v) => s + v.qty, 0);
                        return [reg.data, `${totalMP.toFixed(2)} kg`, `${totalEq} unid.`];
                    });

                    doc.autoTable({
                        startY: y + 5,
                        head: [['Data', 'Total Matéria-Prima', 'Total Equipamentos']],
                        body: ecopontoBody,
                        theme: 'grid',
                        headStyles: { fillColor: [6, 78, 59] }
                    });
                }


                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    addFooter(doc, i, pageCount);
                }

                doc.save(`Relatorio_Sustentabilidade_${new Date().toISOString().slice(0,10)}.pdf`);
            }

            // --- FUNÇÕES AUXILIARES ---

            async function generateProductionReport(doc, filteredEquipamentos, filteredMateriaPrima, y) {
                const materiaPrimaAggr = {};
                filteredMateriaPrima.forEach(reg => {
                    (reg.quantidades || []).forEach(item => {
                        const pesoKg = item.unit === 't' ? item.qty * 1000 : item.qty;
                        materiaPrimaAggr[item.nome] = (materiaPrimaAggr[item.nome] || 0) + pesoKg;
                    });
                });

                if (Object.keys(materiaPrimaAggr).length > 0) {
                    const chartCanvas = document.createElement('canvas');
                    chartCanvas.width = 400; chartCanvas.height = 400;
                    const chartCtx = chartCanvas.getContext('2d');
                    new Chart(chartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(materiaPrimaAggr),
                            datasets: [{
                                data: Object.values(materiaPrimaAggr),
                                backgroundColor: ['#059669', '#10B981', '#34D399', '#6EE7B7'],
                            }]
                        },
                        options: { responsive: false, animation: { duration: 0 }, plugins: { legend: { position: 'right' } } }
                    });
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const chartImage = chartCanvas.toDataURL('image/png');
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Composição da Matéria-Prima (Produção)', 14, y);
                    doc.addImage(chartImage, 'PNG', 14, y + 5, 70, 70);
                }

                const equipAggr = {};
                filteredEquipamentos.forEach(reg => {
                    (reg.items || []).forEach(item => {
                        const tipo = item.tipo || item.nome;
                        equipAggr[tipo] = (equipAggr[tipo] || 0) + (item.qty || 1);
                    });
                });
                const topEquipamentos = Object.entries(equipAggr).sort((a,b) => b[1] - a[1]).slice(0, 10);

                if(topEquipamentos.length > 0){
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Top Equipamentos (Produção)', 110, y);
                    doc.autoTable({
                        startY: y + 5,
                        head: [['Equipamento', 'Unidades']],
                        body: topEquipamentos,
                        theme: 'grid',
                        headStyles: { fillColor: [6, 78, 59] },
                        margin: { left: 110 }
                    });
                    return doc.autoTable.previous.finalY > y + 75 ? doc.autoTable.previous.finalY + 15 : y + 90;
                }
                return y;
            }

            async function generateEcopontoReport(doc, filteredEcoponto, y) {
                const materiaPrimaAggrEcoponto = {};
                filteredEcoponto.forEach(reg => {
                    Object.entries(reg.materiasPrimas || {}).forEach(([nome, peso]) => {
                        materiaPrimaAggrEcoponto[nome] = (materiaPrimaAggrEcoponto[nome] || 0) + peso;
                    });
                });

                if (Object.keys(materiaPrimaAggrEcoponto).length > 0) {
                    const chartCanvas = document.createElement('canvas');
                    chartCanvas.width = 400; chartCanvas.height = 400;
                    const chartCtx = chartCanvas.getContext('2d');
                    new Chart(chartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(materiaPrimaAggrEcoponto),
                            datasets: [{
                                data: Object.values(materiaPrimaAggrEcoponto),
                                backgroundColor: ['#059669', '#10B981', '#34D399', '#6EE7B7'],
                            }]
                        },
                        options: { responsive: false, animation: { duration: 0 }, plugins: { legend: { position: 'right' } } }
                    });
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const chartImage = chartCanvas.toDataURL('image/png');
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Composição da Matéria-Prima (Ecoponto)', 14, y);
                    doc.addImage(chartImage, 'PNG', 14, y + 5, 70, 70);
                }

                const equipAggrEcoponto = {};
                 filteredEcoponto.forEach(reg => {
                    (reg.equipamentos || []).forEach(item => {
                        equipAggrEcoponto[item.nome] = (equipAggrEcoponto[item.nome] || 0) + item.qty;
                    });
                });
                const topEquipamentosEcoponto = Object.entries(equipAggrEcoponto).sort((a,b) => b[1] - a[1]).slice(0, 10);

                if(topEquipamentosEcoponto.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Top Equipamentos (Ecoponto)', 110, y);
                    doc.autoTable({
                        startY: y + 5,
                        head: [['Equipamento', 'Unidades']],
                        body: topEquipamentosEcoponto,
                        theme: 'grid',
                        headStyles: { fillColor: [6, 78, 59] },
                        margin: { left: 110 }
                    });
                    return doc.autoTable.previous.finalY > y + 75 ? doc.autoTable.previous.finalY + 15 : y + 90;
                }
                return y;
            }

            async function generateReport() {
                const doc = new window.jspdf.jsPDF();

                drawHeader(doc, logoBase64);

                const clienteId = document.getElementById('report-cliente-filter').value;
                const startDate = document.getElementById('report-data-inicio').value;
                const endDate = document.getElementById('report-data-fim').value;
                const reportType = document.getElementById('report-type').value;
                const clienteNome = clienteId === 'todos' ? 'Todos os Clientes' : document.getElementById('report-cliente-filter').options[document.getElementById('report-cliente-filter').selectedIndex].text;

                const filterPredicate = (item) => {
                    const date = item.dataInicio || item.data;
                    const clienteMatch = !clienteId || clienteId === 'todos' || item.clienteId === clienteId;
                    const startDateMatch = !startDate || new Date(date) >= new Date(startDate);
                    const endDateMatch = !endDate || new Date(date) <= new Date(endDate);
                    return clienteMatch && startDateMatch && endDateMatch;
                };

                let filteredEquipamentos = [];
                let filteredMateriaPrima = [];
                let filteredEcoponto = [];

                if (reportType === 'producao' || reportType === 'geral') {
                    filteredEquipamentos = liveEquipamentos.filter(filterPredicate);
                    filteredMateriaPrima = liveMateriaPrima.filter(filterPredicate);
                }
                if (reportType === 'ecoponto' || reportType === 'geral') {
                    filteredEcoponto = liveEcopontoRegistos.filter(filterPredicate);
                }

                let totalEquipUnid = filteredEquipamentos.reduce((sum, item) => sum + (item.totalUnidades || 0), 0);
                let totalMateriaPrimaKg = filteredMateriaPrima.reduce((sum, item) => sum + (item.pesoTotal || 0), 0);
                let totalResiduosKg = filteredEquipamentos.reduce((sum, item) => sum + (parseFloat(item.pesoTotal) || 0), 0) + totalMateriaPrimaKg;

                filteredEcoponto.forEach(reg => {
                    totalEquipUnid += (reg.equipamentos || []).reduce((sum, item) => sum + item.qty, 0);
                    const mpKg = Object.values(reg.materiasPrimas || {}).reduce((sum, val) => sum + val, 0);
                    totalMateriaPrimaKg += mpKg;
                    totalResiduosKg += mpKg;
                });

                const totalCo2EvitadoKg = totalMateriaPrimaKg * 1.5;

                doc.setFontSize(11);
                doc.text(`Cliente: ${clienteNome}`, 14, 40);
                doc.text(`Período: ${startDate || 'Início'} a ${endDate || 'Fim'}`, 14, 46);
                doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-PT')}`, 14, 52);

                drawSummaryCards(doc, totalResiduosKg, totalEquipUnid, totalMateriaPrimaKg, totalCo2EvitadoKg);

                let y = 100;

                if (reportType === 'producao' || reportType === 'geral') {
                    y = await generateProductionReport(doc, filteredEquipamentos, filteredMateriaPrima, y);
                }
                if (reportType === 'ecoponto' || reportType === 'geral') {
                    y = await generateEcopontoReport(doc, filteredEcoponto, y);
                }

                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    drawFooter(doc, i, pageCount);
                }

                doc.save(`Relatorio_Sustentabilidade_${new Date().toISOString().slice(0,10)}.pdf`);
            }

            function updateClienteDropdowns(clientes) {
                // This will handle the main filters that show all clients
                const filterSelects = document.querySelectorAll('#cliente-filter, #ecoponto-cliente-filter, #report-cliente-filter');
                filterSelects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '<option value="todos">Todos os Clientes</option>' + clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                    select.value = currentValue;
                });

                // Update form dropdowns with filtering
                updateFormClienteDropdowns('equipamento-cliente-select', 'Produção', clientes);
                updateFormClienteDropdowns('materia-prima-cliente-select', 'Produção', clientes);
                updateFormClienteDropdowns('ecoponto-form-cliente-select', 'Ecoponto', clientes);
            }

            function updateFormClienteDropdowns(selectId, tipo, allClientes) {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                const filteredClientes = allClientes.filter(c => c.tipo === tipo);
                select.innerHTML = '<option value="">Selecione um Cliente</option>' + filteredClientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                select.value = currentValue;
            }
            
            async function seedProdutos() {
                const produtosIniciais = [
                    {nome: 'Desktop', categoria: 'Equipamento', origem: 'Produção'}, {nome: 'Portátil', categoria: 'Equipamento', origem: 'Produção'},
                    {nome: 'Monitor', categoria: 'Equipamento', origem: 'Produção'}, {nome: 'Impressora', categoria: 'Equipamento', origem: 'Produção'},
                    {nome: 'Teclado', categoria: 'Equipamento', origem: 'Produção'}, {nome: 'Rato', categoria: 'Equipamento', origem: 'Produção'},
                    {nome: 'TV', categoria: 'Equipamento', origem: 'Ecoponto'}, {nome: 'Frigorífico', categoria: 'Equipamento', origem: 'Ecoponto'},
                    {nome: 'Cabos Diversos', categoria: 'Equipamento', origem: 'Produção'}, {nome: 'Transformador', categoria: 'Equipamento', origem: 'Produção'},
                    {nome: 'Comando', categoria: 'Equipamento', origem: 'Ecoponto'}, {nome: 'Projector', categoria: 'Equipamento', origem: 'Produção'},
                    {nome: 'Cobre', categoria: 'Matéria-prima', origem: 'Produção'}, {nome: 'Alumínio', categoria: 'Matéria-prima', origem: 'Produção'},
                    {nome: 'Plástico (ABS)', categoria: 'Matéria-prima', origem: 'Produção'}, {nome: 'Placas de Circuito', categoria: 'Matéria-prima', origem: 'Produção'},
                    {nome: 'Ferro', categoria: 'Matéria-prima', origem: 'Produção'}, {nome: 'Baterias de Lítio', categoria: 'Matéria-prima', origem: 'Produção'},
                ];
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'produtos');
                for (const produto of produtosIniciais) {
                    await addDoc(collectionRef, produto);
                }
            }
            
            function renderEcopontoFormEquipamentos() {
                const container = document.getElementById('ecoponto-form-equipamentos-container');
                const equipamentosDisponiveis = liveProdutos.filter(p => p.categoria === 'Equipamento' && p.origem === 'Ecoponto');
                container.innerHTML = equipamentosDisponiveis.map(eq => `
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${eq.nome}</label>
                        <input type="number" min="0" data-nome="${eq.nome}" class="ecoponto-equipamento-qty w-full border border-gray-300 rounded-md p-2 shadow-sm" placeholder="Unidades">
                    </div>
                `).join('');
            }
            
            async function saveEcopontoRegisto(e) {
                e.preventDefault();
                const button = e.currentTarget.querySelector('button[type="submit"]');
                setButtonLoadingState(button, true);

                const id = document.getElementById('ecoponto-form-id').value;
                const select = document.getElementById('ecoponto-form-cliente-select');
                const data = {
                    clienteId: select.value,
                    clienteNome: select.options[select.selectedIndex].text,
                    data: document.getElementById('ecoponto-form-data').value,
                    responsavelNome: currentUserNome,
                    responsavelId: userId,
                    materiasPrimas: {},
                    equipamentos: []
                };

                // Materias Primas
                const metal = parseFloat(document.getElementById('ecoponto-form-metal').value) || 0;
                if(metal > 0) data.materiasPrimas['Metal'] = metal;
                const plasticos = parseFloat(document.getElementById('ecoponto-form-plasticos').value) || 0;
                if(plasticos > 0) data.materiasPrimas['Plásticos'] = plasticos;
                const vidro = parseFloat(document.getElementById('ecoponto-form-vidro').value) || 0;
                if(vidro > 0) data.materiasPrimas['Vidro'] = vidro;
                const papel = parseFloat(document.getElementById('ecoponto-form-papel').value) || 0;
                if(papel > 0) data.materiasPrimas['Papel'] = papel;

                // Equipamentos
                document.querySelectorAll('.ecoponto-equipamento-qty').forEach(input => {
                    const qty = parseInt(input.value, 10) || 0;
                    if (qty > 0) {
                        data.equipamentos.push({ nome: input.dataset.nome, qty: qty });
                    }
                });

                try {
                    const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'ecoponto_registos');
                     if (id) {
                        await updateDoc(doc(collectionRef, id), data);
                        showInfoModal('Sucesso', 'Registo do ecoponto atualizado com sucesso!');
                    } else {
                        await addDoc(collectionRef, data);
                        showInfoModal('Sucesso', 'Registo do ecoponto salvo com sucesso!');
                    }
                    document.getElementById('ecoponto-registo-form').reset();
                    document.getElementById('ecoponto-form-id').value = '';
                    closeModal();
                    document.querySelector('.nav-link[data-page="ecoponto"]').click();
                } catch(error) {
                    console.error("Erro ao salvar registo do ecoponto:", error);
                    showInfoModal('Erro', 'Não foi possível salvar o registo.');
                } finally {
                    setButtonLoadingState(button, false);
                }
            }
            
            async function handleEcopontoListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;

                const id = target.dataset.id;
                if (!id) return;

                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'ecoponto_registos');

                if (target.classList.contains('delete-ecoponto')) {
                    showConfirmationModal('Apagar Registo de Ecoponto', 'Tem a certeza que quer apagar este registo? Esta ação não pode ser desfeita.', async () => {
                        try {
                            await deleteDoc(doc(collectionRef, id));
                            showInfoModal('Sucesso', 'Registo apagado com sucesso.');
                        } catch (error) {
                            console.error("Erro ao apagar registo do ecoponto:", error);
                            showInfoModal('Erro', 'Não foi possível apagar o registo.');
                        }
                    });
                }

                if (target.classList.contains('edit-ecoponto')) {
                    const docRef = doc(collectionRef, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        document.querySelector('.nav-link[data-page="ecoponto-form"]').click();

                        // Preencher o formulário
                        setTimeout(() => { // Timeout para garantir que a página mudou
                            document.getElementById('ecoponto-registo-form').reset();
                            document.getElementById('ecoponto-form-id').value = id;
                            document.getElementById('ecoponto-form-title').textContent = 'Editar Registo de Ecoponto';
                            document.getElementById('ecoponto-form-cliente-select').value = data.clienteId;
                            document.getElementById('ecoponto-form-data').value = data.data;

                            if (data.materiasPrimas) {
                                document.getElementById('ecoponto-form-metal').value = data.materiasPrimas['Metal'] || '';
                                document.getElementById('ecoponto-form-plasticos').value = data.materiasPrimas['Plásticos'] || '';
                                document.getElementById('ecoponto-form-vidro').value = data.materiasPrimas['Vidro'] || '';
                                document.getElementById('ecoponto-form-papel').value = data.materiasPrimas['Papel'] || '';
                            }
                            
                            if (data.equipamentos) {
                                data.equipamentos.forEach(item => {
                                    const input = document.querySelector(`.ecoponto-equipamento-qty[data-nome="${item.nome}"]`);
                                    if (input) {
                                        input.value = item.qty;
                                    }
                                });
                            }
                        }, 100);
                    }
                }
            }


            // --- GRÁFICOS ---
            const charts = {};
            function createCharts() {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js não foi carregado.');
                    return;
                }
                const chartOptions = { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } };
                const barChartOptions = { indexAxis: 'y', ...chartOptions };

                if (document.getElementById('recolhasChart')) {
                    charts.recolhas = new Chart(document.getElementById('recolhasChart').getContext('2d'), { 
                        type: 'bar', data: { labels: [], datasets: [{ label: 'Recolhas (kg)', data: [], backgroundColor: 'rgba(5, 150, 105, 0.6)', borderRadius: 5 }] }, options: chartOptions 
                    });
                }
                if (document.getElementById('topEquipamentosChart')) {
                    charts.topEquipamentos = new Chart(document.getElementById('topEquipamentosChart').getContext('2d'), { 
                        type: 'bar', data: { labels: [], datasets: [{ label: 'Quantidade', data: [], backgroundColor: 'rgba(5, 150, 105, 0.6)', borderRadius: 5 }] }, options: barChartOptions
                     });
                }
            }

            function updateCharts(equipamentosData, materiaPrimaData){
                if (Object.keys(charts).length === 0) return;
                // Gráfico de Recolhas
                if(charts.recolhas) {
                    const recolhasAggr = {};
                    const allData = [...equipamentosData, ...materiaPrimaData];
                    allData.forEach(item => {
                        if (item.dataInicio) {
                            const monthYear = new Date(item.dataInicio).toISOString().slice(0, 7); // YYYY-MM
                            const pesoKg = parseFloat(item.pesoTotal) || 0;
                            recolhasAggr[monthYear] = (recolhasAggr[monthYear] || 0) + pesoKg;
                        }
                    });
                    const sortedLabels = Object.keys(recolhasAggr).sort();
                    charts.recolhas.data.labels = sortedLabels;
                    charts.recolhas.data.datasets[0].data = sortedLabels.map(label => recolhasAggr[label]);
                    charts.recolhas.update();
                }

                // Gráfico Top 5 Equipamentos
                if(charts.topEquipamentos){
                    const equipAggr = {};
                    equipamentosData.forEach(reg => {
                        (reg.items || []).forEach(item => {
                            const tipo = item.tipo || item.nome; // Compatibilidade com dados antigos
                            equipAggr[tipo] = (equipAggr[tipo] || 0) + (item.qty || 1);
                        });
                    });
                    const top5 = Object.entries(equipAggr).sort((a,b) => b[1] - a[1]).slice(0, 5);
                    charts.topEquipamentos.data.labels = top5.map(item => item[0]);
                    charts.topEquipamentos.data.datasets[0].data = top5.map(item => item[1]);
                    charts.topEquipamentos.update();
                }
            }
            
            init(); // Chama a função de inicialização principal
        });
    </script>
</body>
</html>

